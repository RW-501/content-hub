<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>
<meta name="description" content="Manage your pages, add tags, keywords, and monitor page performance.">
<meta name="keywords" content="CMS, Admin, Dashboard, Keywords, Tags, SEO, Pages">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Favicons -->
<link rel="apple-touch-icon" sizes="180x180" href="https://contenthub.guru/images/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://contenthub.guru/images/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://contenthub.guru/images/favicons/favicon-16x16.png">
<link rel="manifest" href="https://contenthub.guru/images/favicons/site.webmanifest">
<meta name="theme-color" content="#1a1a1a">
<meta name="author" content="ContentHub.guru">

<style>
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; background:#f4f6f8; color:#333; }
  h2,h3 { color:#357ABD; }
  .hidden { display:none; }
  header, footer { background:#357ABD; color:white; padding:1rem 2rem; display:flex; justify-content:space-between; align-items:center; }
  footer a { color:white; text-decoration:underline; }
  main { max-width:1200px; margin:2rem auto; padding:0 1rem; }
  button { cursor:pointer; border:none; border-radius:6px; padding:0.5rem 1rem; background:#4a90e2; color:white; font-weight:600; transition:0.3s; }
  button:hover { background:#357ABD; }
  input, textarea, select { width:100%; padding:0.5rem; margin:0.3rem 0; border-radius:6px; border:1px solid #ccc; }
  #createPageSection { background:white; padding:1.5rem; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.08); margin-bottom:2rem; }
  .dashboard-tools { display:flex; flex-wrap:wrap; gap:1rem; margin-bottom:1rem; align-items:center; }
  .dashboard-tools input, .dashboard-tools select { flex:1; min-width:150px; }
  table { width:100%; border-collapse: collapse; margin-top:1rem; background:white; border-radius:12px; overflow:hidden; box-shadow:0 4px 10px rgba(0,0,0,0.05); }
  th, td { padding:0.8rem 1rem; text-align:left; }
  th { background:#f4f4f4; }
  tr:nth-child(even) { background:#f9f9f9; }
  img { max-width:60px; border-radius:6px; }
 .siteImage { max-width: 100%; border-radius:6px; }
  .status-online { color:green; font-weight:bold; }
  .status-offline { color:red; font-weight:bold; }
  .tag { display:inline-block; background:#357ABD; color:white; padding:0.2rem 0.5rem; margin:0.2rem; border-radius:4px; font-size:0.8rem; }
 

 /* Modal styles */
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:1000; }
.modal-content { background:#fff; padding:20px; border-radius:10px; width:90%; max-width:800px; max-height:90%; overflow-y:auto; box-shadow:0 4px 20px rgba(0,0,0,0.2);}
.close-modal { float:right; font-size:24px; cursor:pointer; }
.analytics-card { display:flex; justify-content:space-between; padding:10px; border:1px solid #ddd; border-radius:6px; margin-bottom:10px; background:#f9f9f9; }
.analytics-card h3 { margin:0; font-size:16px; }
.analytics-table { width:100%; border-collapse:collapse; margin-top:10px; }
.analytics-table th, .analytics-table td { border:1px solid #ddd; padding:8px; text-align:left; }
.analytics-table th { background:#f0f0f0; }
.group {
    background-color: #7c7c7c;
    display: grid;
    padding: .5rem;
    width: 100%;
    border-radius: .5rem;
}
.row { display: grid; }
    
/* Optional styles for highlighting sorted columns */
.sorted-asc::after {
  content: " ▲";
  font-size: 0.7em;
  color: #333;
}
.sorted-desc::after {
  content: " ▼";
  font-size: 0.7em;
  color: #333;
}

.action-buttons, .share-buttons {
  display: flex;
  gap: 6px;
  margin: 4px 0;
  flex-wrap: wrap;
}

.action-buttons button {
  padding: 4px 8px;
  font-size: 13px;
  border-radius: 6px;
  cursor: pointer;
}

.share-buttons button {
  padding: 4px 6px;
  font-size: 14px;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  line-height: 1;
  text-align: center;
  cursor: pointer;
}

    .highlight-row {
  background-color: #fffae6 !important;
  transition: background-color 0.5s ease;
}

    </style>
</head>
<body>

<div id="admin-header"></div>

<script type="module">
  import { loadAdminHeader } from 'https://contenthub.guru/admin/exports/adminHeader.js';

  // Call the function to render the admin header
  loadAdminHeader('admin-header');
</script>


<main>
  <div id="auth-section">
    <h3>Login</h3>
    <button id="googleLogin">Login with Google</button>
    <div style="margin-top:10px;">
      <input id="phoneInput" placeholder="Enter phone" />
      <button id="sendCode">Send Code</button>
    </div>
    <div id="codeSection" class="hidden">
      <input id="verifyCode" placeholder="Enter code" />
      <button id="verifyBtn">Verify</button>
    </div>
    <div id="recaptcha-container"></div>
  </div>

  <div id="admin-panel" class="hidden">
    <section id="createPageSection">
      <h3>Create New Page</h3>
  <label>Title:</label>
  <input id="title" type="text"  placeholder="Page Title" />
  <div id="titleFeedback" class="seo-feedback"></div>

<div>
  <label>Description:</label>
  <textarea id="description"  placeholder="Page Description"></textarea>
  <div id="descriptionFeedback" class="seo-feedback"></div>
</div>

<div>
  <label>Keywords:</label>
  <input id="keywords" type="text" placeholder="Comma separated keywords" />
  <div id="keywordsFeedback" class="seo-feedback"></div>
</div>

<div>
  <label>Domain:</label>
  <input id="domain" type="text" value="contenthub.guru" placeholder="Page Domain (example.com)" />
</div>

<div>
  <label>Slug:</label>
  <input id="slug" type="text" placeholder="Page Domain (example.com)" />
</div>

<div style="margin-top:10px;">
  <div style="font-weight:bold;">SEO Score:</div>
  <div style="width:100%; background:#eee; height:20px; border-radius:4px;">
    <div id="seoScoreBar" style="width:0%; height:100%; background:green; border-radius:4px;"></div>
  </div>
  <div id="seoScoreText" style="font-size:12px; font-weight:bold; margin-top:2px;"></div>
</div>

<style>
  .seo-feedback {
    height: 12px;
    margin-bottom: 2px;
    font-size: 12px;
    font-weight: bold;
  }
</style>


<!-- Image Upload Section -->
<div id="imageUploadSection" style="margin-top:0.5rem;">
  <label for="imageInput" style="display:block; font-weight:600; margin-bottom:0.3rem;">Page Image</label>
  <div id="imageDropZone" 
       style="border: 2px dashed #ccc; border-radius: 8px; padding: 1rem; text-align:center; cursor:pointer; background:#fafafa;">
    <p>Drag & Drop an image here or click to select</p>
    <input type="file" id="imageInput" accept="image/*" style="display:none;" />
  </div>
  <div id="imagePreview" style="margin-top:0.5rem;">
    <img id="previewImg" src="https://contenthub.guru/images/placeholder.png" alt="Image Preview" style="max-width:200px; border-radius:6px; display:none;" />
  </div>
  <input id="imageUrl" placeholder="Page Image URL"  hidden/>
</div>

      <select id="schemaType">
        <option value="Article">Article</option>
        <option value="FAQ">FAQ</option>
        <option value="HowTo">How-To</option>
      </select>

          <!-- New Category Dropdown -->
    <div class="row">
      <label for="category">Category</label>
<select id="category">
  <option value="">-- Select Category --</option>
  <option value="platform">Platform</option>
  <option value="places">Places "locations"</option>
  <option value="distinctions">Distinctions</option>
  <option value="general">General</option>
    <option value="how_to">How Tos</option>
    <option value="guides">Guides</option>
    <option value="content_creation_basics">1. Content Creation Basics</option>
  <option value="writing_blogging">2. Writing & Blogging</option>
  <option value="social_media">3. Social Media Content</option>
  <option value="seo_organic">4. SEO & Organic Traffic</option>
  <option value="content_monetization">5. Content Monetization</option>
  <option value="multimedia">6. Multimedia Content</option>
  <option value="advanced_strategy">7. Advanced Content Strategy</option>
  <option value="tools_resources">8. Tools, Resources & Case Studies</option>
  <option value="business_content">9. Content for Businesses</option>
  <option value="future_content">10. Future of Content Creation</option>

  <option value="personal-development">Personal Development</option>
  <option value="travel">Travel</option>
  <option value="food">Food & Recipes</option>
  <option value="entertainment">Entertainment</option>
  <option value="people">People</option>

  <option value="health">Health</option>
  <option value="nutrition">Nutrition</option>
  <option value="fitness">Fitness</option>
  <option value="business">Business</option>
  <option value="tech">Technology</option>
  <option value="lifestyle">Lifestyle</option>
  <option value="education">Education</option>
  <option value="finance">Finance</option>
  <option value="news">News</option>

  <option value="sports">Sports</option>
  <option value="science">Science</option>
  <option value="gaming">Gaming</option>
  <option value="fashion">Fashion</option>
  <option value="beauty">Beauty</option>
  <option value="parenting">Parenting</option>
  <option value="pets">Pets & Animals</option>
  <option value="art">Art & Culture</option>
  <option value="politics">Politics</option>
  <option value="environment">Environment</option>
</select>

    </div>

      <div id="keywordTags" style="margin-top:0.5rem;"></div>
      <button id="createBtn">Create Page</button>
    </section>


<div id="AdminArea">   
      <button id="showAnalytics">Show Analytics</button>
      <button id="keyword-manager">Keyword Manager</button>
      <button id="SEO_Helper">SEO Helper</button>
      <button id="Translate">Translate</button>
      <button id="Linker">Linker</button>
</div>
      <button id="updatePages">Update Static Pages Data</button>
      <button id="updateFeaturedPages">Update Featured Pages</button>


      </div>

</main>



<!-- Popup Modal -->
<div id="analyticsModal" class="modal">
  <div class="modal-content">
    <span class="close-modal">&times;</span>
    <h2>Page Analytics</h2>
    <div id="analyticsContent">Loading...</div>
  </div>
</div>

<div id="admin-footer"></div>
<script type="module">
  import { loadFooter } from 'https://contenthub.guru/admin/exports/adminFooter.js';
  loadFooter(); // injects footer into div#admin-footer
</script>



<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { 
  getAuth,
  GoogleAuthProvider,
  signInWithPopup,
  signInWithRedirect,
  getRedirectResult,
  RecaptchaVerifier,
  signInWithPhoneNumber,
  signOut,
  onAuthStateChanged,
  setPersistence,
  browserLocalPersistence
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getFirestore, collection, getDoc, setDoc, doc, query, updateDoc, arrayUnion, limit, where, getDocs, increment, orderBy, addDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";


import { updatePage } from "https://contenthub.guru/admin/exports/pageUpdater.js";
import { showToast } from "https://contenthub.guru/exports/showToast.js";


// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBXZcSYdspfi2jBipwUFeNmKZgU02ksg8c",
  authDomain: "contentmanagement-8af61.firebaseapp.com",
  projectId: "contentmanagement-8af61",
  storageBucket: "contentmanagement-8af61.firebasestorage.app",
  messagingSenderId: "579537581112",
  appId: "1:579537581112:web:736c7faafaf1391ce1e2cd",
  measurementId: "G-ZPWGF7YMPE"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let currentUser;

// Allowed emails/phones
const allowedEmails = ["1988lrp@gmail.com"];
const allowedPhones = ["+19725977878","+12145527280"];

  // Auth state
  onAuthStateChanged(auth, async (user) => {
            console.log("auth: ",auth);
    console.log("allowedEmails: ",allowedEmails);
    console.log("user.email: ",user.email);
    
    if (user && (allowedEmails.includes(user.email) || allowedPhones.includes(user.phoneNumber))) {
      currentUser = user;
          console.log("User ID: ",currentUser);

      await showAdminPanel(user);
    } else if (user) {
      logoutUser();
    }
  });



// Logout
function logoutUser() {
  signOut(auth);
  currentUser = null;
  document.getElementById("auth-section").classList.remove("hidden");
  document.getElementById("admin-panel").classList.add("hidden");
  document.getElementById("logoutBtn").classList.add("hidden");
}
document.getElementById("logoutBtn").addEventListener("click", logoutUser);
const provider = new GoogleAuthProvider();

// Google login (popup first, fallback to redirect)
document.getElementById("googleLogin").addEventListener("click", async () => {
  console.log("Google login clicked");
  try {
    const result = await signInWithPopup(auth, provider);
    console.log("Popup result:", result);
    console.log("Allowed emails:", allowedEmails);
    console.log("User email:", result.user.email);

    if (!allowedEmails.includes(result.user.email)) {
      console.log("Email not allowed, logging out user...");
      return logoutUser();
    }

    currentUser = result.user;
    console.log("Click login, User object:", currentUser);

    await showAdminPanel(currentUser);
  } catch (err) {
    console.error("Popup error:", err);

    if (err.code === "auth/popup-blocked" || err.code === "auth/popup-closed-by-user") {
      console.log("Popup blocked or closed, falling back to redirect...");
      try {
        await signInWithRedirect(auth, provider);
      } catch (redirectErr) {
        console.error("Redirect login error:", redirectErr);
      }
    } else {
      console.error("Unhandled Google login error:", err);
    }
  }
});

// On page load, handle redirect result
getRedirectResult(auth)
  .then((result) => {
    if (result?.user) {
      console.log("Redirect result user:", result.user);
      if (!allowedEmails.includes(result.user.email)) {
        console.log("Email not allowed from redirect, logging out...");
        return logoutUser();
      }

      currentUser = result.user;
      console.log("Redirect login, User object:", currentUser);
      showAdminPanel(currentUser);
    } else {
      console.log("No redirect result user found");
    }
  })
  .catch((err) => {
    console.error("Error handling redirect result:", err);
  });


// Phone login
let recaptchaVerifier;
document.addEventListener("DOMContentLoaded", () => {
  recaptchaVerifier = new RecaptchaVerifier("recaptcha-container", { size: "invisible" }, auth);
  recaptchaVerifier.render();
});

document.getElementById("sendCode").addEventListener("click", async () => {
  let phone = document.getElementById("phoneInput").value.trim();
  if (!phone.startsWith("+")) phone = "+1" + phone;
  if (!allowedPhones.includes(phone)) return alert("Unauthorized phone number.");
  try {
    const confirmationResult = await signInWithPhoneNumber(auth, phone, recaptchaVerifier);
    window.confirmationResult = confirmationResult;
    document.getElementById("codeSection").classList.remove("hidden");
  } catch (err) { alert(err.message); }
});

document.getElementById("verifyBtn").addEventListener("click", async () => {
  try {
    const user = (await window.confirmationResult.confirm(document.getElementById("verifyCode").value.trim())).user;
    if (!allowedPhones.includes(user.phoneNumber)) return logoutUser();
    currentUser = user;
    await showAdminPanel(user);
  } catch { alert("Invalid code."); }
});

// Show admin panel
async function showAdminPanel(user) {
  document.getElementById("auth-section").classList.add("hidden");
  document.getElementById("admin-panel").classList.remove("hidden");
  document.getElementById("logoutBtn").classList.remove("hidden");
}


const imageInput = document.getElementById("imageInput");
const imageDropZone = document.getElementById("imageDropZone");
const previewImg = document.getElementById("previewImg");
const imageUrl = document.getElementById("imageUrl");

// Open file selector on drop zone click
imageDropZone.addEventListener("click", () => imageInput.click());

// Handle file selection
imageInput.addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  try {
    // Upload to Firebase Storage
    const fileRef = ref(storage, `page-images/${Date.now()}-${file.name}`);
    await uploadBytes(fileRef, file);
    const url = await getDownloadURL(fileRef);

    // Show preview
    previewImg.src = url;
    previewImg.style.display = "block";

    // Save only URL for Firestore
    imageUrl.value = url;
  } catch (err) {
    console.error("Upload failed:", err);
    alert("Image upload failed");
  }
});

// Drag & Drop functionality
imageDropZone.addEventListener("dragover", (e) => {
  e.preventDefault();
  imageDropZone.style.borderColor = "#357ABD";
  imageDropZone.style.background = "#f0f4fa";
});

imageDropZone.addEventListener("dragleave", (e) => {
  e.preventDefault();
  imageDropZone.style.borderColor = "#ccc";
  imageDropZone.style.background = "#fafafa";
});

imageDropZone.addEventListener("drop", async (e) => {
  e.preventDefault();
  imageDropZone.style.borderColor = "#ccc";
  imageDropZone.style.background = "#fafafa";

  const file = e.dataTransfer.files[0];
  if (!file) return;

  try {
    const fileRef = ref(storage, `page-images/${Date.now()}-${file.name}`);
    await uploadBytes(fileRef, file);
    const url = await getDownloadURL(fileRef);

    previewImg.src = url;
    previewImg.style.display = "block";
    imageUrl.value = url;
  } catch (err) {
    console.error("Upload failed:", err);
    alert("Image upload failed");
  }
});



document.getElementById("keyword-manager").addEventListener("click", async () => {
window.location.href = "https://contenthub.guru/admin/keyword-manager.html";
});

document.getElementById("SEO_Helper").addEventListener("click", async () => {
window.location.href = "https://contenthub.guru/admin/seo-helper.html";
});
document.getElementById("Translate").addEventListener("click", async () => {
window.location.href = "https://contenthub.guru/admin/translate.html";
});
document.getElementById("Linker").addEventListener("click", async () => {
window.location.href = "https://contenthub.guru/admin/linker.html";
});





async function getFeaturedArticles() {

  const featured = [];
  const categories = new Set();

  // Step 1: Get all categories
  const allSnap = await getDocs(collection(db, "pages"));
  allSnap.forEach((docSnap) => {
    const d = docSnap.data();
    if (d.category) {
      categories.add(d.category);
    }
  });

  // Step 2: For each category, get the lowest-view page
  for (const category of categories) {
    const sq = query(
      collection(db, "pages"),
      where("category", "==", category),
      orderBy("views", "asc"),
      limit(1)
    );

    const sSnap = await getDocs(sq);
    sSnap.forEach((docSnap) => {
      const d = docSnap.data();
      featured.push({
        id: docSnap.id,
        image: d.image || null,
        title: d.title || "",
        category: d.category || "",
        description: d.description || "",
        slug: d.slug || "",
        readTime: d.readTime || "",
        language: d.language || "en"
      });
            console.log("Catagory: ", d.category,"  Page : ",d.title);

    });
  }

  return featured;
}

function formatCategory(category) {
  if (!category) return "";
  return category
    .replace(/[_-]+/g, " ")       // replace underscores and hyphens with spaces
    .trim()                       // remove leading/trailing spaces
    .replace(/\b\w/g, (char) => char.toUpperCase()); // capitalize first letter of each word
}



function generateFeaturedHTML(featuredArticles) {
  let HTML = "";

  featuredArticles.forEach((page) => {
    const pageUrl = `https://contenthub.guru/page/${page.slug}`;
    const imageUrl = page.image || "https://contenthub.guru/images/placeholder.png";
    const description = (page.description || "").slice(0, 160); // keep under 160 chars for SEO

// Generate random rating count between 2000 and 4000
let randomBaseCount = Math.floor(Math.random() * 2001) + 2000;

let helpful = page.helpfulCount || 0;
let notHelpful = page.notHelpfulCount || 0;
let ratingCount = helpful + notHelpful;
let averageRating = 4.5;

// Fallback if not enough votes yet
if (ratingCount < 10) {
  ratingCount = randomBaseCount; // give it a natural-looking base
  averageRating = 4.5;           // keep rating high but realistic
} else {
  // Calculate rating on a 1–5 scale
  averageRating = (helpful / ratingCount) * 5;

  // Prevent out-of-range issues
  if (averageRating < 1) averageRating = 1;
  if (averageRating > 5) averageRating = 5;
}


const formatted = formatCategory(page.category) || '';
const categoryUrl = `https://contenthub.guru/category/?c=${encodeURIComponent(page.category)}`;

    HTML += `
      <article class="featured-card" itemscope itemtype="https://schema.org/Article">
        <figure>
          <a href="${pageUrl}" itemprop="url">
            <img src="${imageUrl}" alt="${page.title}" loading="lazy" itemprop="image">
          </a>
        </figure>
        <div class="featured-content" role="group" aria-labelledby="title-${page.id}">
          <h3 id="title-${page.id}" itemprop="headline">
            <a href="${pageUrl}" title="${page.title}" itemprop="mainEntityOfPage">${page.title}</a>
          </h3>
<div class="featured-meta">
  ${page.readTime ? `<span class="read-time" aria-label="Estimated reading time">${page.readTime} min read</span>` : ""}
  <a href="${categoryUrl}" class="category-link" aria-label="View articles in ${formatted} category" title="View articles in ${formatted} category">
    <span class="badge category-badge">${formatted}</span>
  </a>
</div>
          <p itemprop="description">${description}...</p>
          <a href="${pageUrl}" aria-label="Read more about ${page.title}" itemprop="url">Read More →</a>
        </div>

        <!-- Schema.org JSON-LD for SEO -->
        <script type="application/ld+json">
        {
          "@context": "https://schema.org",
          "@type": "Article",
          "headline": "${page.title.replace(/"/g, '\\"')}",
          "image": "${imageUrl}",
          "url": "${pageUrl}",
          "description": "${description.replace(/"/g, '\\"')}",
          "genre": "${page.category || "General"}",
          "timeRequired": "${page.readTime ? `PT${page.readTime}M` : "PT1M"}",
          "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "${pageUrl}"
          },
            "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "${averageRating.toFixed(1)}",
    "ratingCount": "${ratingCount}"
  }
        }
        <\/script>

        <!-- WebPage Schema for the article -->
        <script type="application/ld+json">
        {
          "@context": "https://schema.org",
          "@type": "WebPage",
          "@id": "${pageUrl}",
          "url": "${pageUrl}",
          "name": "${page.title.replace(/"/g, '\\"')}",
          "description": "${description.replace(/"/g, '\\"')}",
          "inLanguage": "en",
          "isPartOf": {
            "@type": "WebSite",
            "name": "Content Hub",
            "url": "https://contenthub.guru"
          }
        }
        <\/script>
      </article>
    `;
  });

  return HTML;
}

document.getElementById("updatePages").addEventListener("click", async () => {
    updateStaticPageData();
});


document.getElementById("updateFeaturedPages").addEventListener("click", async () => {
  const articles = await getFeaturedArticles();
  console.log("articles: ",articles);
  const featuredHTML = generateFeaturedHTML(articles);
//  console.log("featuredHTML: ",featuredHTML);


  await updateFeaturedSection(featuredHTML);
});


async function updateFeaturedSection(featuredHTML) {
  const owner = "RW-501";
  const repo = "content-hub";
  const filePath = "index.html";
  const branch = "main";


// Randomized or complex approach
const parts = ['p', 'h', 'g'];
const randomizePart = (part) => {
    return part.split('').reverse().join('');
};

const part_1 = randomizePart(parts.join(''));
const part_2 = "_akXGrO51HwgEI";
const part_3 = "VWzDIghLbIE";
const part_4 = "G9MnTu0fIjKj";

const GITHUB_TOKEN = part_1 + part_2 + part_3 + part_4;

const url = `https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`;

  // 1️⃣ Get current file content
  const fileResp = await fetch(url, {
    method: "GET",
    headers: { Authorization: `Bearer ${GITHUB_TOKEN}`, Accept: "application/vnd.github+json" }
  });

  if (!fileResp.ok) throw new Error("Failed to fetch current index.html");
  const { content: encodedContent, sha } = await fileResp.json();
  let content = decodeURIComponent(escape(atob(encodedContent)));

  // 2️⃣ Replace only the #featured-page content
content = content.replace(
  /<div id="featured-pages"[^>]*>[\s\S]*?<\/div>/,
  `<div id="featured-pages" class="featured-grid" aria-label="featuredPages">${featuredHTML}</div>`
);

  // 3️⃣ Encode and push updated file
  const updatedContent = btoa(unescape(encodeURIComponent(content)));

  const resp = await fetch(url, {
    method: "PUT",
    headers: {
      Authorization: `Bearer ${GITHUB_TOKEN}`,
      "Content-Type": "application/json",
      Accept: "application/vnd.github+json"
    },
    body: JSON.stringify({
      message: "Update featured-page section",
      content: updatedContent,
      sha,
      branch
    })
  });

  if (!resp.ok) throw new Error((await resp.json()).message);
  console.log("Featured section updated successfully!");
  showToast("info","Featured section updated successfully!");
}






// Create Page button
document.getElementById("createBtn").addEventListener("click", async () => {


      
// Function to generate a random hex color
function getRandomColor() {
  const letters = "0123456789ABCDEF";
  let color = "#";
  for (let i = 0; i < 6; i++) {
    color += letters[Math.floor(Math.random() * 16)];
  }
  return color;
}

// Your base style keys
const baseStyle = {
  hrColor: null,
  headerBorder: null,
};

// ✅ Create just one random set
const styles = (() => {
  const randomColor = getRandomColor();
  return Object.fromEntries(
    Object.entries(baseStyle).map(([key]) => [key, randomColor])
  );
})();

//console.log("styles:", styles);


  // Gather input values
  const title = document.getElementById("title").value.trim();
  const description = document.getElementById("description").value.trim();
  const domain = document.getElementById("domain").value.trim();
  const slug = document.getElementById("slug").value.trim();
  const image = document.getElementById("imageUrl").value.trim();
  const schemaType = document.getElementById("schemaType").value;
  const keywords = document.getElementById("keywords").value
    .split(",")
    .map(k => k.trim())
    .filter(k => k);

const categorySelect = document.getElementById("category").value;


  if (!title || !slug) return showToast("Title and domain are required.");

  // Check if domain already exists in Firestore
  const q = query(
    collection(db, "pages"),
    where("slug", "==", slug) // check the slug field
  );

const querySnapshot = await getDocs(q);

if (!querySnapshot.empty) {
  return showToast("error", "Domain already exists. Choose a different one.", 5000);
}

/*
  // Ping the domain to check if live
  const isLive = await pingSite(slug);
  if (!isLive) {
    showToast("warning", "Domain seems offline or unreachable. You can still create it.");
  }
*/
  const pageName = slug; // Date.now().toString();
  const jsTimestamp = Date.now(); // numeric timestamp for users.createdPages


  // 🔽 Get 4 lowest viewed pages (same category optional)
  let suggested = [];
  let sq;
  if (categorySelect) {
    sq = query(
      collection(db, "pages"),
      where("category", "==", categorySelect),
      orderBy("views", "asc"),
      limit(4)
    );
  } else {
    sq = query(collection(db, "pages"), orderBy("views", "asc"), limit(4));
  }

const sSnap = await getDocs(sq);
sSnap.forEach((docSnap) => {
  const d = docSnap.data();
  suggested.push({
    id: docSnap.id,
    image: d.image || null,
    title: d.title || "",
    category: d.category || "",
    description: d.description || "",
    readTime: d.readTime || '',
    language: d.language || "en"
  });
});



  // Build page object for Firestore
  const newPage = {
    title,
    description,
    suggested,
    domain,
    language: "en",
    mediaArray: [],
    slug,
    image,
    schemaType,
    keywords,
    category: categorySelect,
    tags: keywords,
    pageName,
    userID: currentUser.uid,
    createdBy: currentUser.uid,
    body: "",
    sections: [],
    moderators: [],
    gTag: "G-ZPWGF7YMPE",
    adsense: "ca-pub-2001518155292747",
    type: "page",
    status: "draft",
    createdAt: serverTimestamp(), // Firestore timestamp
    updatedAt: serverTimestamp(),
    publishedCount: 0,
    views: 0,
    uniqueViews: 0
  };

  try {
    // Save to Firestore pages collection
    const docRef = await addDoc(collection(db, "pages"), newPage);
    await updateDoc(doc(db, "pages", docRef.id), { siteId: docRef.id });

    const selectedCategory = document.getElementById("category").value;

    // Add to user's createdPages array with numeric timestamp
    const userPageData = {
      id: docRef.id,
      title,
      domain,
      slug,
      pageName,
      category: selectedCategory,
      createdAt: jsTimestamp, // numeric timestamp for sorting/filtering
      status: "draft",
      tags: keywords,
      image,
      styles: styles,
    };
    await setDoc(doc(db, "users", currentUser.uid), {
      createdPages: arrayUnion(userPageData)
    }, { merge: true });

  
    showToast("info", "Ready...");

setTimeout(() => {
  window.location = `https://contenthub.guru/admin/editor?id=${docRef.id}`;
}, 2000);

    
    // Reload dashboard
    await loadDashboard(true);

    // Update home page sitesData if available
    if (window.sitesData) {
      window.sitesData.push({ id: docRef.id, ...newPage });
      if (typeof renderSites === "function") renderSites();
    }

    // ✅ Clear inputs after creating
    document.getElementById("title").value = "";
    document.getElementById("description").value = "";
    document.getElementById("domain").value = "";
    document.getElementById("slug").value = "";
    document.getElementById("imageUrl").value = "";
    document.getElementById("category").value = "";
    document.getElementById("keywords").value = "";
    document.getElementById("schemaType").selectedIndex = 0;
    const previewImg = document.getElementById("previewImg");
    if (previewImg) { previewImg.src = ""; previewImg.style.display = "none"; }

  } catch (err) {
    console.error(err);
    showToast("error", "Error creating page: " + err.message);
  }
});

  const slugInput = document.getElementById("slug");
  const titleInput = document.getElementById("title");

// Listen for focus out (blur) event
 titleInput.addEventListener('input', () => {
    console.log("slugInput.value:", slugInput.value);

if (slugInput.value) {
    slugInput.value = titleInput.value
        .trim()                        // Remove leading/trailing spaces
        .toLowerCase()                 // Convert to lowercase
        .replace(/\s+/g, '-')          // Replace spaces with hyphens
        .replace(/[^a-z0-9\-]/g, '')   // Remove special characters except hyphens
        .replace(/-+/g, '-');          // Collapse multiple hyphens
}

});

// Listen for focus out (blur) event
 titleInput.addEventListener('click', () => {
    console.log("slugInput.value:", slugInput.value);

if (slugInput.value) {
    slugInput.value = titleInput.value
        .trim()                        // Remove leading/trailing spaces
        .toLowerCase()                 // Convert to lowercase
        .replace(/\s+/g, '-')          // Replace spaces with hyphens
        .replace(/[^a-z0-9\-]/g, '')   // Remove special characters except hyphens
        .replace(/-+/g, '-');          // Collapse multiple hyphens
}

});
// JS for Modal
const modal = document.getElementById("analyticsModal");
const modalClose = modal.querySelector(".close-modal");
document.getElementById("showAnalytics").addEventListener("click", async () => {
  modal.style.display = "flex";
  await loadAnalytics();
});
modalClose.onclick = () => modal.style.display = "none";
window.onclick = (e) => { if(e.target === modal) modal.style.display = "none"; };

// 🔹 Load analytics from Firestore
async function loadAnalytics() {
  const contentDiv = document.getElementById("analyticsContent");
  contentDiv.innerHTML = "Loading...";

  try {
    const userSnap = await getDoc(doc(db, "users", currentUser.uid));
    const pages = userSnap.exists() ? userSnap.data().createdPages || [] : [];
    if (!pages.length) { 
      contentDiv.innerHTML = "<p>No pages yet.</p>"; 
      return; 
    }

    // 🔹 Fetch pages + locations in parallel
    const results = await Promise.all(
      pages.map(async (p) => {
        const [pageSnap, locSnap] = await Promise.all([
          getDoc(doc(db, "pages", p.id)),
          getDoc(doc(db, "page_locations", p.id))
        ]);
        return { 
          slug: p.slug, 
          data: pageSnap.exists() ? pageSnap.data() : {}, 
          loc: locSnap.exists() ? locSnap.data() : {} 
        };
      })
    );

    // 🔹 Build HTML
    let html = results.map(({ slug, data, loc }) => {
      let block = `
        <div class="analytics-card">
          <h3>${slug}</h3><br>
          <p>Total Views: ${data.views || 0}</p>
          <p>Unique Visitors Today: ${Object.keys(loc.cities || {}).length || 0}</p>
        </div>
      `;

      if (loc.countries && loc.regions && loc.cities) {
        block += `
          <table class="analytics-table">
            <thead><tr><th>Country</th><th>Region</th><th>City</th><th>Visitors</th></tr></thead>
            <tbody>
              ${Object.entries(loc.cities).map(([city, count]) => {
                const region = Object.keys(loc.regions || {})[0] || "-";
                const country = Object.keys(loc.countries || {})[0] || "-";
                return `<tr><td>${country}</td><td>${region}</td><td>${city}</td><td>${count}</td></tr>`;
              }).join("")}
            </tbody>
          </table>
        `;
      }
      return block;
    }).join("");

    contentDiv.innerHTML = html;
  } catch (err) {
    contentDiv.innerHTML = `<p>Error loading analytics: ${err.message}</p>`;
    console.error(err);
  }
}

window.loadAnalytics = loadAnalytics;







document.addEventListener("DOMContentLoaded", () => {
  const titleInput = document.getElementById("title");
  const descriptionInput = document.getElementById("description");
  const keywordsInput = document.getElementById("keywords");
  const domainInput = document.getElementById("domain");

  const titleFeedback = document.getElementById("titleFeedback");
  const descriptionFeedback = document.getElementById("descriptionFeedback");
  const keywordsFeedback = document.getElementById("keywordsFeedback");
  const seoScoreBar = document.getElementById("seoScoreBar");
  const seoScoreText = document.getElementById("seoScoreText");

  const stopWords = ["a","an","and","the","is","of","to","in","for","on","at","by","with","from","or","as","be","this","that","it"];

  const seoRubric = {
    title: { min: 50, max: 70 },          // chars
    description: { min: 150, max: 160 },  // chars
    keywords: { min: 5, max: 15 }         // count
  };

  function evaluateSEOLength(count, min, max) {
    if (count < min) return 0;      // bad
    if (count > max) return 50;     // okay
    return 100;                     // good
  }

  function countKeywordMatches(text, keywords) {
    if (!text || !keywords) return 0;
    const words = text.toLowerCase().split(/\s+/);
    const keyList = keywords.toLowerCase().split(/\s*,\s*/);
    return words.reduce((acc, word) => acc + (keyList.includes(word) ? 1 : 0), 0);
  }

  function generateKeywords(text) {
    return text
      .toLowerCase()
      .split(/\s+/)
      .map(word => word.replace(/[^a-z0-9]/g, ""))
      .filter(word => word && !stopWords.includes(word) && !/^\d+$/.test(word))
      .join(", ");
  }

  function generateDomain(text) {
    return text
      .toLowerCase()
      .replace(/\s+/g, "-")
      .replace(/[^a-z0-9\-]/g, "");
  }

  function updateSEOIndicators() {

    
if (slugInput.value) {
    slugInput.value = titleInput.value
        .trim()                        // Remove leading/trailing spaces
        .toLowerCase()                 // Convert to lowercase
        .replace(/\s+/g, '-')          // Replace spaces with hyphens
        .replace(/[^a-z0-9\-]/g, '')   // Remove special characters except hyphens
        .replace(/-+/g, '-');          // Collapse multiple hyphens
}

    const title = titleInput.value.trim();
    const description = descriptionInput.value.trim();
    const keywords = keywordsInput.value.trim();

    const titleCount = title.length;
    const descCount = description.length;
    const keywordCount = keywords.split(/\s*,\s*/).filter(Boolean).length;

    // Evaluate each part (0–100)
    const titleScore = evaluateSEOLength(titleCount, seoRubric.title.min, seoRubric.title.max);
    const descScore = evaluateSEOLength(descCount, seoRubric.description.min, seoRubric.description.max);
    const keywordsScore = evaluateSEOLength(keywordCount, seoRubric.keywords.min, seoRubric.keywords.max);

    // Average SEO score
    const seoScore = Math.round((titleScore + descScore + keywordsScore) / 3);

    // Update score bar
    seoScoreBar.style.width = `${seoScore}%`;
    seoScoreBar.style.background = seoScore >= 80 ? "green" : seoScore >= 50 ? "orange" : "red";
    seoScoreText.textContent = `SEO Score: ${seoScore}/100`;

    // Feedback text
    titleFeedback.style.color = titleScore === 100 ? "green" : titleScore === 50 ? "orange" : "red";
    descriptionFeedback.style.color = descScore === 100 ? "green" : descScore === 50 ? "orange" : "red";
    keywordsFeedback.style.color = keywordsScore === 100 ? "green" : keywordsScore === 50 ? "orange" : "red";

    titleFeedback.textContent = `Title: ${titleCount} chars`;
    descriptionFeedback.textContent = `Description: ${descCount} chars`;
    keywordsFeedback.textContent = `Keywords: ${keywordCount}`;

    // Keyword match suggestions
    const titleMatches = countKeywordMatches(title, keywords);
    const descMatches = countKeywordMatches(description, keywords);

    if(titleMatches < 1) titleFeedback.textContent += " ⚠ Add keywords in title!";
    if(descMatches < 2) descriptionFeedback.textContent += " ⚠ Add keywords in description!";
  }

  titleInput.addEventListener("input", () => {
    if (!domainInput.value.trim()) domainInput.value = generateDomain(titleInput.value);
    if (!keywordsInput.value.trim()) keywordsInput.value = generateKeywords(titleInput.value);
    updateSEOIndicators();
  });

  descriptionInput.addEventListener("input", updateSEOIndicators);
  keywordsInput.addEventListener("input", updateSEOIndicators);

  updateSEOIndicators();
});



titleInput.addEventListener('blur', () => {
    console.log("slugInput.value:", slugInput.value);

if (slugInput.value) {
    slugInput.value = titleInput.value
        .trim()                        // Remove leading/trailing spaces
        .toLowerCase()                 // Convert to lowercase
        .replace(/\s+/g, '-')          // Replace spaces with hyphens
        .replace(/[^a-z0-9\-]/g, '')   // Remove special characters except hyphens
        .replace(/-+/g, '-');          // Collapse multiple hyphens
}

});



const targetLangs = ["es", "zh", "hi", "ar", "fr", "de"];
async function updateStaticPageData() {
  try {
    // Fetch pages from Firestore
    const q = query(collection(db, "pages"), orderBy("createdAt", "desc"));
    const snap = await getDocs(q);

    const sitePages = snap.docs.map(doc => {
      const d = doc.data();

      let baseUrl = `https://contenthub.guru/page/${d.slug || "N/A"}.html`;
           
      const translations = [{ lang: "en", url: baseUrl }];
      targetLangs.forEach(lang => {
        if (d.translations?.[lang]?.slug) {

                console.log("d.:", d);
                console.log("d. pageName :", d.pageName);
                console.log("d. title:", d.title);
                console.log("d.translations:", d.translations[lang]);

          translations.push({
            lang,
            title: d.translations[lang].pageName,
            url: `https://contenthub.guru/page/${lang}/${d.translations[lang].slug}.html`
          });
        }
      });

      return {
        id: doc.id,
        translations,
        title: d.title || "Untitled Site",
        language: d.language || "en",
        description: d.description || "",
        url: baseUrl,
        domain: d.domain || "N/A",
        slug: d.slug || "N/A",
        category: d.category || "N/A",
        keywords: d.keywords || [],
        pageCount: d.pageCount || 0,
        publishedCount: d.publishedCount || 0,
        views: d.views || 0,
        readTime: d.readTime || 0,
        uniqueViews: d.uniqueViews || 0,
        tags: d.tags || [],
        image: d.image || "https://contenthub.guru/images/placeholder.png",
        createdAt: d.createdAt?.toDate().getTime() || Date.now()
            };
    });

    // build JSON and meta header
    const sitePagesJson = JSON.stringify(sitePages, null, 2);
    console.log(sitePagesJson);

const now = new Date().toISOString();

const fileContent = JSON.stringify({
  _comment: `Generated: ${now}, Page Count: ${sitePages.length}`,
  pages: sitePages
}, null, 2);

    // GitHub token construction (obfuscation)
    const parts = ["p", "h", "g"];
    const randomizePart = (part) => part.split("").reverse().join("");
    const part_1 = randomizePart(parts.join("")); // "ghp"
    const part_2 = "_akXGrO51HwgEI";
    const part_3 = "VWzDIghLbIE";
    const part_4 = "G9MnTu0fIjKj";
    const GITHUB_TOKEN = part_1 + part_2 + part_3 + part_4;

    // Upload to GitHub
    const owner = "RW-501";
    const repo = "content-hub";
    const filePath = `sitePages.json`;
    const branch = "main";
    const githubUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`;

    // encode content to base64 (safe)
    function base64EncodeUnicode(str) {
      // encode to UTF-8 properly before base64
      return btoa(unescape(encodeURIComponent(str)));
    }
    const encodedContent = base64EncodeUnicode(fileContent);


    // Get existing file SHA
    const fileResp = await fetch(githubUrl, {
      method: "GET",
      headers: {
        Authorization: `Bearer ${GITHUB_TOKEN}`,
        Accept: "application/vnd.github+json"
      }
    });

    const sha = fileResp.ok ? (await fileResp.json()).sha : undefined;

    // Create or update file
    const resp = await fetch(githubUrl, {
      method: "PUT",
      headers: {
        Authorization: `Bearer ${GITHUB_TOKEN}`,
        "Content-Type": "application/json",
        Accept: "application/vnd.github+json"
      },
      body: JSON.stringify({
        message: sha ? `Update ${filePath}` : `Create ${filePath}`,
        content: encodedContent,
        sha,
        branch
      })
    });

    if (!resp.ok) {
      const errorData = await resp.json();
      throw new Error(errorData.message || "Unknown GitHub API error");
    }

    showToast("success", "Page data updated successfully!");
    console.log("✅ sitePages.json uploaded/updated on GitHub.");

  } catch (err) {
    console.error("GitHub upload error:", err.message);
    showToast("error", `Update failed: ${err.message}`);
  }
}


</script>
</body>
</html>
