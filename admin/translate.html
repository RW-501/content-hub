<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Translate Pages Dashboard</title>

<!-- Favicons -->
<link rel="apple-touch-icon" sizes="180x180" href="https://contenthub.guru/images/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://contenthub.guru/images/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://contenthub.guru/images/favicons/favicon-16x16.png">
<link rel="manifest" href="https://contenthub.guru/images/favicons/site.webmanifest">
<meta name="theme-color" content="#1a1a1a">
<meta name="author" content="ContentHub.guru">

<style>
  * { box-sizing: border-box; }
  :root { --card:#fff; --ink:#222; --muted:#666; --bg:#f7f7f9; --border:#e6e6ea; --accent:#4f46e5; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:var(--bg); color:var(--ink); }

  /* Container grid */
  #pages {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1.5rem;
    padding: 1.5rem;
  }

  /* Page card */
  .page-card {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 1rem 1.25rem;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .page-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 14px rgba(0,0,0,0.08);
  }
  .page-card h3 {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
  }
  .page-card p {
    font-size: 0.9rem;
    color: #6b7280;
    margin-bottom: 0.75rem;
  }

  /* Language buttons */
  .lang-btn {
    margin: 4px;
    padding: 6px 12px;
    border: none;
    font-size: 0.85rem;
    font-weight: 600;
    color: #fff;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s, transform 0.15s;
  }
  .lang-btn:hover {
    transform: scale(1.05);
  }
  .lang-btn.translated { background-color: #16a34a; }   /* green */
  .lang-btn.not-translated { background-color: #dc2626; } /* red */

  /* Reset button */
  .reset-btn {
    margin: 4px;
    padding: 6px 10px;
    font-size: 0.8rem;
    font-weight: 500;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    background: #f9fafb;
    color: #374151;
    cursor: pointer;
    transition: background 0.2s, transform 0.15s;
  }
  .reset-btn:hover {
    background: #f3f4f6;
    transform: scale(1.05);
  }

  /* Logs */
  #log,
  #status {
    margin: 1.5rem;
    padding: 1rem;
    background: #1f2937;
    color: #d1d5db;
    font-family: monospace;
    font-size: 0.85rem;
    border-radius: 8px;
    height: 150px;
    overflow-y: auto;
    white-space: pre-wrap;
    box-shadow: inset 0 0 6px rgba(0,0,0,0.4);
  }

  main { width: 95%; margin: 0 auto; }

  /* Base button */
  button {
    display: inline-block;
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
    font-weight: 600;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
  }
</style>
</head>
<body>

<div id="admin-header"></div>
<script type="module">
  import { loadAdminHeader } from 'https://contenthub.guru/admin/exports/adminHeader.js';
  loadAdminHeader('admin-header');
</script>

<main>
  <h1>Translate Pages Dashboard</h1>

  


  <button id="translateWithDelayBtn">Translate & Update All Pages</button>

  <div class="container">
    <h3 style="margin:1.5rem 0 0.5rem 1.5rem;">Logs</h3>
    <pre id="status"></pre>
    <pre id="log"></pre>
  </div>

  <div id="pages"></div>
</main>

<div id="admin-footer"></div>
<script type="module">
  import { loadFooter } from 'https://contenthub.guru/admin/exports/adminFooter.js';
  loadFooter();
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getFirestore, getDocs, query, collection } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

  import { translatePageLanguage, resetTranslation, removePage } from "https://contenthub.guru/admin/exports/updateArticle.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBXZcSYdspfi2jBipwUFeNmKZgU02ksg8c",
    authDomain: "contentmanagement-8af61.firebaseapp.com",
    projectId: "contentmanagement-8af61",
    storageBucket: "contentmanagement-8af61.firebasestorage.app",
    messagingSenderId: "579537581112",
    appId: "1:579537581112:web:736c7faafaf1391ce1e2cd",
    measurementId: "G-ZPWGF7YMPE"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const targetLangs = ["es", "zh", "hi", "ar","fr", "de"];
  const pagesContainer = document.getElementById("pages");
  const logEl = document.getElementById("log");
  function log(msg) { logEl.textContent += msg + "\n"; }


  
  /* ---------------- Fetch and Render Pages ---------------- */
async function loadPages() {
  const q = query(collection(db, "pages"));
  const snap = await getDocs(q);
  pagesContainer.innerHTML = "";

  snap.forEach(docSnap => {
    const data = docSnap.data();
    const pageId = docSnap.id;

    const div = document.createElement("div");
    div.className = "page-card";

    // Determine default URL (English or original)
    const defaultUrl = `https://contenthub.guru/page/${data.slug}.html`;

    // Create clickable title linking to default page
    const titleLink = document.createElement("a");
    titleLink.href = defaultUrl;
    titleLink.textContent = data.title;
    titleLink.target = "_blank"; // open in new tab
    div.appendChild(titleLink);

    // Show slug
    const slugP = document.createElement("p");
    slugP.textContent = `Slug: ${data.slug}`;
    div.appendChild(slugP);

    // Language buttons
    targetLangs.forEach(lang => {
      const translated = data.translatedLanguages?.[lang] === true;

      const btn = document.createElement("button");
      btn.className = "lang-btn " + (translated ? "translated" : "not-translated");
      btn.textContent = lang.toUpperCase();

      btn.onclick = async () => {
        log(`🔄 Translating ${data.slug} → ${lang.toUpperCase()}`);
              console.log(`pageId ${pageId} → ${lang.toUpperCase()} Slug:`, data.slug);
      let waitMs =  await translatePageLanguage(pageId, data, lang);
                   
      if (waitMs && waitMs > 0) {
      log(`⚠ Quota hit. Pausing for ${formatTime(waitMs / 1000)}...`);
                   }else{
      console.log(`Done ????????`);
      log(`Done ????????`);

                   }


       // await loadPages();
      };
      div.appendChild(btn);


      if (translated && data.translations?.[lang]?.slug) {
        // Link to translated page
        const translatedLink = document.createElement("a");

        translatedLink.href = `https://contenthub.guru/page/${lang}/${data.translations[lang].slug}.html`;
        translatedLink.textContent = `Go to ${lang.toUpperCase()} version`;
        translatedLink.target = "_blank";
        translatedLink.style.display = "block";
        translatedLink.style.marginTop = "4px";
        div.appendChild(translatedLink);

        // Optional: Reset translation
        const resetBtn = document.createElement("button");
        resetBtn.className = "reset-btn";
        resetBtn.textContent = "Reset";

        resetBtn.onclick = async () => {
          const filePath = `page/${lang}/${data.slug}.html`;
          log(`♻ Resetting ${filePath} (${lang})`);
          await resetTranslation(pageId, lang);
          await removePage(pageId, filePath);
          await loadPages();
        };
        div.appendChild(resetBtn);
      }
    });

    pagesContainer.appendChild(div);
  });
}



  
const JOB_KEY = "safeTranslateJob"; // localStorage key

async function safeTranslateWithDelay() {
  const languages = ["es", "zh", "hi", "ar", "fr", "de"];
  const q = query(collection(db, "pages"));
  const snap = await getDocs(q);
  const pages = snap.docs.map(doc => ({ id: doc.id, data: doc.data() }));
  const total = pages.length;

  // Try to resume progress
  let jobState = JSON.parse(localStorage.getItem(JOB_KEY)) || {
    langIndex: 0,
    pageIndex: 0,
    doneCount: 0,
    startTime: Date.now(),
  };

  for (let li = jobState.langIndex; li < languages.length; li++) {
    const targetLang = languages[li];
    log(`🚀 Starting SAFE bulk translation for ${targetLang.toUpperCase()}...`);
    let prevSlug = "";

    for (let pi = jobState.pageIndex; pi < pages.length; pi++) {
      const { id: pageId, data } = pages[pi];
      const currentSlug = data.slug;

      if (data.translatedLanguages?.[targetLang]) {
        log(`⚡ Skipping ${currentSlug}, already translated to ${targetLang.toUpperCase()}`);
        jobState.pageIndex = pi + 1; // advance index
        continue;
      }

      try {
        const chunkStart = Date.now();
        statusDiv.innerHTML = `
          <strong>Lang:</strong> ${targetLang.toUpperCase()} <br>
          <strong>Page:</strong> ${currentSlug} <br>
          <strong>Progress:</strong> ${jobState.doneCount}/${total} <br>
          <strong>Elapsed:</strong> ${formatTime((Date.now() - jobState.startTime) / 1000)}
        `;

        let waitMs = await translatePageLanguage(pageId, data, targetLang);

        if (waitMs && waitMs > 0) {
          log(`⚠ Quota hit. Pausing for ${formatTime(waitMs / 1000)}...`);
          statusDiv.innerHTML += `<br>⚠ Quota hit. Waiting ${formatTime(waitMs / 1000)}...`;

          // Save state before waiting
          localStorage.setItem(JOB_KEY, JSON.stringify({ 
            ...jobState, langIndex: li, pageIndex: pi 
          }));

          await new Promise(res => setTimeout(res, waitMs));
        } else {
          jobState.doneCount++;
          prevSlug = currentSlug;

          // Save progress
          jobState.langIndex = li;
          jobState.pageIndex = pi + 1;
          localStorage.setItem(JOB_KEY, JSON.stringify(jobState));

          // Wait 60s pacing
          for (let i = 60; i > 0; i--) {
            statusDiv.innerHTML += `<br>⏳ Waiting ${i}s before next page...`;
            await new Promise(res => setTimeout(res, 1000));
          }
        }
      } catch (err) {
        log(`❌ Error on ${currentSlug}: ${err.message}`);
      }
    }

    log(`🎉 Finished ${targetLang.toUpperCase()} translation`);
    jobState.pageIndex = 0; // reset for next language
    localStorage.setItem(JOB_KEY, JSON.stringify(jobState));
  }

  // Cleanup after finishing all languages
  localStorage.removeItem(JOB_KEY);
  statusDiv.innerHTML = `✅ All translations done!`;
  await loadPages();
}

/* Heartbeat every 30 mins */
setInterval(() => {
  const jobState = JSON.parse(localStorage.getItem(JOB_KEY));
  if (jobState) {
    console.log("💓 Heartbeat: still working...", jobState);
    jobState.lastHeartbeat = Date.now();
    localStorage.setItem(JOB_KEY, JSON.stringify(jobState));
  }
}, 30 * 60 * 1000);

  const translateWithDelayBtn = document.getElementById('translateWithDelayBtn');

        translateWithDelayBtn.addEventListener('click', () => {
          safeTranslateWithDelay();
        });
        

// Helper to format seconds into mm:ss
function formatTime(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}m ${secs}s`;
}


  /* ---------------- Start ---------------- */
  loadPages();
</script>
</body>
</html>
