<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Auto Link Admin</title>
  <!-- Favicons -->
  <link rel="apple-touch-icon" sizes="180x180" href="https://contenthub.guru/images/favicons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://contenthub.guru/images/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://contenthub.guru/images/favicons/favicon-16x16.png">
  <link rel="manifest" href="https://contenthub.guru/images/favicons/site.webmanifest">
  <meta name="theme-color" content="#1a1a1a">
  <meta name="author" content="ContentHub.guru">

  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; background:#f4f6f8; color:#333; }
    h2,h3 { color:#357ABD; }
    .hidden { display:none; }
    header, footer { background:#357ABD; color:white; padding:1rem 2rem; display:flex; justify-content:space-between; align-items:center; }
    footer a { color:white; text-decoration:underline; }
    main { max-width:1200px; margin:2rem auto; padding:0 1rem; }
    button { cursor:pointer; border:none; border-radius:6px; padding:0.5rem 1rem; background:#4a90e2; color:white; font-weight:600; transition:0.3s; }
    button:hover { background:#357ABD; }
    input, textarea, select { width:100%; padding:0.5rem; margin:0.3rem 0; border-radius:6px; border:1px solid #ccc; }

    #keywordModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    #keywordModalContent { background: #fff; padding: 20px; width: 400px; max-height: 80%; overflow: auto; border-radius: 8px; }
    .keyword-item { display: flex; justify-content: space-between; margin: 5px 0; }
    .keyword-item button { background: red; color: #fff; border: none; padding: 2px 5px; cursor: pointer; }
    #linkLog { margin-top: 10px; max-height: 300px; overflow: auto; font-size: 12px; border: 1px solid #ddd; padding: 5px; }
    #linkStats { margin-top: 8px; }
    #currentText { margin-top:10px; padding:10px; border:1px solid #ccc; background:#fff; max-height:150px; overflow:auto; font-size:14px; }
    mark.test-link { background: yellow; }
  </style>
</head>
<body>

<div id="admin-header"></div>
<script type="module">
  import { loadAdminHeader } from 'https://contenthub.guru/admin/exports/adminHeader.js';
  loadAdminHeader('admin-header');
</script>

<main>
  <h2>üîó Auto Link Admin</h2>

  <div style="margin:10px 0;padding:10px;border:1px solid #ccc;">
    <button onclick="startAutoLink()">‚ñ∂ Start All Pages</button>
    <button onclick="stopAutoLink()">‚èπ Stop</button>
    <button onclick="skipKeyword()">‚è≠ Skip Keyword</button>
    <button onclick="toggleTestMode()">üîÄ Toggle Test Mode</button>
    <button onclick="openKeywordModal()">üìù Manage Keywords</button>
    <br><br>
    <input id="pageIdInput" placeholder="Enter page ID..." style="padding:5px;width:250px;">
    <button onclick="updateCurrentPage()">üìÑ Update Current Page</button>
    <div id="linkStats">
      Test Mode: <span id="testModeStatus">ON</span><br>
      Current Page: <span id="currentPage">None</span><br>
      Words: 0 | Max Links: 0 | Inserted: 0
    </div>
    <div>
      <strong>Keywords to link:</strong>
      <ul id="keywordsList"></ul>
    </div>
    <div>
      <strong>Current Text Preview:</strong>
      <div id="currentText"><em>Text that will be updated appears here...</em></div>
    </div>
  </div>

  <div id="linkLog"><em>Log will appear here...</em></div>
</main>

<div id="keywordModal">
  <div id="keywordModalContent">
    <h3>Manage Keywords</h3>
    <input id="newKeyword" placeholder="Keyword..." style="width:70%;padding:5px;">
    <input id="newSlug" placeholder="Slug..." style="width:25%;padding:5px;">
    <button onclick="addKeyword()">‚ûï Add</button>
    <ul id="modalKeywordList"></ul>
    <button onclick="closeKeywordModal()">Close</button>
  </div>
</div>

<div id="admin-footer"></div>
<script type="module">
  import { loadFooter } from 'https://contenthub.guru/admin/exports/adminFooter.js';
  loadFooter();
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, collection, doc, getDoc, getDocs, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBXZcSYdspfi2jBipwUFeNmKZgU02ksg8c",
  authDomain: "contentmanagement-8af61.firebaseapp.com",
  projectId: "contentmanagement-8af61",
  storageBucket: "contentmanagement-8af61.firebasestorage.app",
  messagingSenderId: "579537581112",
  appId: "1:579537581112:web:736c7faafaf1391ce1e2cd",
  measurementId: "G-ZPWGF7YMPE"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// üîπ Global state
let autoLinkRunning = false;
let linkIndex = 0;
let keywordsArray = [];
let maxLinks = 0;
let insertedLinks = 0;
let processedPages = 0;
let testMode = true; // default ON
let currentPreviewText = "";

// üîπ Helpers
function log(msg) {
  const el = document.getElementById("linkLog");
  el.innerHTML += `<div>${msg}</div>`;
  el.scrollTop = el.scrollHeight;
  updateKeywordDisplay();
}
function updateKeywordDisplay() {
  const ul = document.getElementById("keywordsList");
  ul.innerHTML = "";
  keywordsArray.forEach(k => {
    const li = document.createElement("li");
    li.textContent = `${k.keyword} ‚Üí /site/${k.slug}`;
    ul.appendChild(li);
  });
  document.getElementById("testModeStatus").innerText = testMode ? "ON" : "OFF";
}

// üîπ Modal for keywords with Firestore updates
function openKeywordModal() {
  const modal = document.getElementById("keywordModal");
  modal.style.display = "flex";
  renderModalList();
}
function closeKeywordModal() { document.getElementById("keywordModal").style.display = "none"; }

function renderModalList() {
  const ul = document.getElementById("modalKeywordList");
  ul.innerHTML = "";
  keywordsArray.forEach((k, i) => {
    const li = document.createElement("li");
    li.className = "keyword-item";
    li.innerHTML = `${k.keyword} ‚Üí /site/${k.slug} <button onclick="removeKeyword(${i})">‚ùå</button>`;
    ul.appendChild(li);
  });
}

async function addKeyword() {
  const kw = document.getElementById("newKeyword").value.trim();
  const slug = document.getElementById("newSlug").value.trim();
  if (!kw || !slug) return alert("Enter both keyword and slug");
  const newKeyword = { keyword: kw, slug: slug };
  keywordsArray.push(newKeyword);
  updateKeywordDisplay();
  renderModalList();
  document.getElementById("newKeyword").value = "";
  document.getElementById("newSlug").value = "";

  // Save to Firestore keywords collection
  await setDoc(doc(db,"keywords",slug), newKeyword);
  log(`‚úÖ Added keyword "${kw}" ‚Üí /site/${slug}`);
}

async function removeKeyword(i) {
  const removed = keywordsArray.splice(i, 1)[0];
  updateKeywordDisplay();
  renderModalList();
  // Remove from Firestore
  await updateDoc(doc(db,"keywords",removed.slug), { removed: true });
  log(`‚ùå Removed keyword "${removed.keyword}"`);
}

// üîπ Auto-link logic
function escapeRegExp(string) { return string.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"); }
function stripHtml(html) { return html.replace(/<[^>]+>/g, ""); }

async function autoLinkBlocks(blocks, slug) {
  if (!blocks || !Array.isArray(blocks)) return blocks;

  const totalWords = blocks
    .filter(b => b.type === "paragraph" && b.html)
    .map(b => stripHtml(b.html).split(/\s+/).length)
    .reduce((a,b)=>a+b,0);

  maxLinks = Math.max(1, Math.floor(totalWords/200)*2);
  insertedLinks = 0;
  linkIndex = 0;
  document.getElementById("currentPage").innerText = slug;

  for (let i=0;i<blocks.length;i++) {
    if (!autoLinkRunning || insertedLinks>=maxLinks) break;
    if (blocks[i].type==="paragraph" && blocks[i].html) {
      currentPreviewText = blocks[i].html;
      document.getElementById("currentText").innerHTML = currentPreviewText;
      blocks[i].html = await processBlock(blocks[i].html, slug);
    }
  }

  document.getElementById("linkStats").innerText =
    `Test Mode: ${testMode ? "ON" : "OFF"} | Page: ${slug} | Words: ${totalWords} | Max Links: ${maxLinks} | Inserted: ${insertedLinks}`;

  return blocks;
}

async function processBlock(html, slug, perBlockLimit=1) {
  let replaced = 0;
  while (linkIndex < keywordsArray.length && insertedLinks < maxLinks) {
    const { keyword, slug: targetSlug } = keywordsArray[linkIndex];
    if (slug===targetSlug) { linkIndex++; continue; }
    if (html.includes(`/site/${targetSlug}`)) { linkIndex++; continue; }

    const regex = new RegExp(`\\b(${escapeRegExp(keyword)})\\b`, "i");
    const link = testMode
      ? `<mark class="test-link">$1</mark>`
      : `<a href="/site/${targetSlug}">$1</a>`;

    if (regex.test(html)) {
      html = html.replace(regex, link);
      insertedLinks++; replaced++;
      currentPreviewText = html;
      document.getElementById("currentText").innerHTML = currentPreviewText;
      log(`${testMode?"üü° Preview":"üîó Linked"} "${keyword}" ‚Üí /site/${targetSlug}`);
      if (replaced>=perBlockLimit) break;
    }
    linkIndex++;
  }
  return html;
}

// üîπ Controls
function startAutoLink() { autoLinkRunning = true; runAutoLinkAll(); }
function stopAutoLink() { autoLinkRunning = false; log("‚èπ Auto-link stopped."); }
function skipKeyword() { linkIndex++; log("‚è≠ Skipped keyword."); }
function toggleTestMode() { testMode = !testMode; log(`üîÄ Test Mode ${testMode ? "ON" : "OFF"}`); }

async function updateSinglePage(pageId) {
  const pageRef = doc(db,"pages",pageId);
  const snap = await getDoc(pageRef);
  if (!snap.exists()) { log(`‚ùå Page not found: ${pageId}`); return; }

  const d = snap.data();
  const newBlocks = await autoLinkBlocks(d.blocks,d.slug);

  if (!testMode) {
    await updateDoc(pageRef, { blocks: newBlocks });
    log(`‚úÖ Updated page: ${d.slug} PageId: ${pageId}`);
  } else {
    log(`üü° Previewed page: ${d.slug} PageId: ${pageId}`);
  }
}

function updateCurrentPage() {
  const pageId = document.getElementById("pageIdInput").value.trim();
  if (!pageId) { log("‚ö†Ô∏è Enter a page ID"); return; }
  autoLinkRunning = true;
  updateSinglePage(pageId);
}

async function runAutoLinkAll() {
  log("‚è≥ Loading pages...");
  const q = collection(db,"pages");
  const snap = await getDocs(q);

  if (snap.empty) { log("‚ùå No pages found."); return; }

  processedPages=0;
  for (const docSnap of snap.docs) {
    if (!autoLinkRunning) break;
    const d = docSnap.data();
    if (!d.blocks) continue;
    await autoLinkBlocks(d.blocks,d.slug);
    if (!testMode) { await updateDoc(doc(db,"pages",docSnap.id), { blocks: d.blocks }); log(`‚úÖ Updated: ${d.slug}`); }
    else log(`üü° Previewed: ${d.slug}`);
    processedPages++;
  }
  log(`üéâ Done! Processed ${processedPages} pages.`);
}

// üîπ Expose to buttons
window.startAutoLink = startAutoLink;
window.stopAutoLink = stopAutoLink;
window.skipKeyword = skipKeyword;
window.toggleTestMode = toggleTestMode;
window.updateCurrentPage = updateCurrentPage;
window.openKeywordModal = openKeywordModal;
window.closeKeywordModal = closeKeywordModal;
window.addKeyword = addKeyword;
window.removeKeyword = removeKeyword;

</script>
</body>
</html>
