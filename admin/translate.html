<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Translate Pages Dashboard</title>

<!-- Favicons -->
<link rel="apple-touch-icon" sizes="180x180" href="https://contenthub.guru/images/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://contenthub.guru/images/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://contenthub.guru/images/favicons/favicon-16x16.png">
<link rel="manifest" href="https://contenthub.guru/images/favicons/site.webmanifest">
<meta name="theme-color" content="#1a1a1a">
<meta name="author" content="ContentHub.guru">

<style>
  * { box-sizing: border-box; }
  :root { --card:#fff; --ink:#222; --muted:#666; --bg:#f7f7f9; --border:#e6e6ea; --accent:#4f46e5; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:var(--bg); color:var(--ink); }

  /* Container grid */
  #pages {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1.5rem;
    padding: 1.5rem;
  }

  /* Page card */
  .page-card {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 1rem 1.25rem;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .page-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 14px rgba(0,0,0,0.08);
  }
  .page-card h3 {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
  }
  .page-card p {
    font-size: 0.9rem;
    color: #6b7280;
    margin-bottom: 0.75rem;
  }

  /* Language buttons */
  .lang-btn {
    margin: 4px;
    padding: 6px 12px;
    border: none;
    font-size: 0.85rem;
    font-weight: 600;
    color: #fff;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s, transform 0.15s;
  }
  .lang-btn:hover {
    transform: scale(1.05);
  }
  .lang-btn.translated { background-color: #16a34a; }   /* green */
  .lang-btn.not-translated { background-color: #dc2626; } /* red */

  /* Reset button */
  .reset-btn {
    margin: 4px;
    padding: 6px 10px;
    font-size: 0.8rem;
    font-weight: 500;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    background: #f9fafb;
    color: #374151;
    cursor: pointer;
    transition: background 0.2s, transform 0.15s;
  }
  .reset-btn:hover {
    background: #f3f4f6;
    transform: scale(1.05);
  }

  /* Logs */
  #log {
    margin: 1.5rem;
    padding: 1rem;
    background: #1f2937;
    color: #d1d5db;
    font-family: monospace;
    font-size: 0.85rem;
    border-radius: 8px;
    height: 150px;
    overflow-y: auto;
    white-space: pre-wrap;
    box-shadow: inset 0 0 6px rgba(0,0,0,0.4);
  }

  main { width: 95%; margin: 0 auto; }

  /* Base button */
  button {
    display: inline-block;
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
    font-weight: 600;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
  }
</style>
</head>
<body>

<div id="admin-header"></div>
<script type="module">
  import { loadAdminHeader } from 'https://contenthub.guru/admin/exports/adminHeader.js';
  loadAdminHeader('admin-header');
</script>

<main>
  <h1>Translate Pages Dashboard</h1>

  <select id="updateLanguage">
    <option value="en">English</option>
    <option value="es">Spanish</option>
    <option value="zh">Chinese</option>
    <option value="hi">Hindi</option>
    <option value="ar">Arabic</option>
    <option value="fr">French</option>
    <option value="de">German</option>
  </select>

  <button id="translateWithDelayBtn">Translate & Update All Pages</button>

  <div class="container">
    <h3 style="margin:1.5rem 0 0.5rem 1.5rem;">Logs</h3>
    <pre id="status"></pre>
    <pre id="log"></pre>
  </div>

  <div id="pages"></div>
</main>

<div id="admin-footer"></div>
<script type="module">
  import { loadFooter } from 'https://contenthub.guru/admin/exports/adminFooter.js';
  loadFooter();
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getFirestore, getDocs, query, collection } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

  import { handleTranslateAndUpdate, translatePageLanguage, resetTranslation, removePage } from "https://contenthub.guru/admin/exports/updateArticle.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBXZcSYdspfi2jBipwUFeNmKZgU02ksg8c",
    authDomain: "contentmanagement-8af61.firebaseapp.com",
    projectId: "contentmanagement-8af61",
    storageBucket: "contentmanagement-8af61.firebasestorage.app",
    messagingSenderId: "579537581112",
    appId: "1:579537581112:web:736c7faafaf1391ce1e2cd",
    measurementId: "G-ZPWGF7YMPE"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const targetLangs = ["es", "zh", "hi", "ar", "fr", "de"];
  const pagesContainer = document.getElementById("pages");
  const logEl = document.getElementById("log");
  function log(msg) { logEl.textContent += msg + "\n"; }


  
  /* ---------------- Fetch and Render Pages ---------------- */
async function loadPages() {
  const q = query(collection(db, "pages"));
  const snap = await getDocs(q);
  pagesContainer.innerHTML = "";

  snap.forEach(docSnap => {
    const data = docSnap.data();
    const pageId = docSnap.id;

    const div = document.createElement("div");
    div.className = "page-card";

    // Determine default URL (English or original)
    const defaultUrl = `https://contenthub.guru/page/${data.slug}.html`;

    // Create clickable title linking to default page
    const titleLink = document.createElement("a");
    titleLink.href = defaultUrl;
    titleLink.textContent = data.title;
    titleLink.target = "_blank"; // open in new tab
    div.appendChild(titleLink);

    // Show slug
    const slugP = document.createElement("p");
    slugP.textContent = `Slug: ${data.slug}`;
    div.appendChild(slugP);

    // Language buttons
    targetLangs.forEach(lang => {
      const translated = data.translatedLanguages?.[lang] === true;

      const btn = document.createElement("button");
      btn.className = "lang-btn " + (translated ? "translated" : "not-translated");
      btn.textContent = lang.toUpperCase();

      btn.onclick = async () => {
        log(`🔄 Translating ${data.slug} → ${lang.toUpperCase()}`);
              console.log(`pageId ${pageId} → ${lang.toUpperCase()} Slug:`, data.slug);
        await translatePageLanguage(pageId, data, lang);
              console.log(`????????????????????????`);


       // await loadPages();
      };
      div.appendChild(btn);

      if (translated) {
        // Link to translated page
        const translatedLink = document.createElement("a");
        translatedLink.href = `https://contenthub.guru/page/${lang}/${data.slug}.html`;
        translatedLink.textContent = `Go to ${lang.toUpperCase()} version`;
        translatedLink.target = "_blank";
        translatedLink.style.display = "block";
        translatedLink.style.marginTop = "4px";
        div.appendChild(translatedLink);

        // Optional: Reset translation
        const resetBtn = document.createElement("button");
        resetBtn.className = "reset-btn";
        resetBtn.textContent = "Reset";

        resetBtn.onclick = async () => {
          const filePath = `page/${lang}/${data.slug}.html`;
          log(`♻ Resetting ${filePath} (${lang})`);
          await resetTranslation(pageId, lang);
          await removePage(pageId, filePath);
          await loadPages();
        };
        div.appendChild(resetBtn);
      }
    });

    pagesContainer.appendChild(div);
  });
}



  

/* ---------------- Safe Bulk Translate Button ---------------- */
const safeBtn = document.getElementById("translateWithDelayBtn");
const statusDiv = document.getElementById("status"); // your div to show progress

safeBtn.textContent = "Translate with Delay (Safe Mode)";

safeBtn.addEventListener("click", async () => {
  const targetLang = document.getElementById("updateLanguage").value;
  log(`🚀 Starting SAFE bulk translation for ${targetLang.toUpperCase()}... (1 min delay each)`);

  const q = query(collection(db, "pages"));
  const snap = await getDocs(q);

  const total = snap.docs.length;
  let doneCount = 0;
  let prevSlug = "";

  const startTime = Date.now();

  for (const docSnap of snap.docs) {
    const data = docSnap.data();
    const pageId = docSnap.id;
    const currentSlug = data.slug;

    
if (data.translatedLanguages?.[targetLang]) {
  log(`⚡ Skipping ${data.slug}, already translated to ${targetLang.toUpperCase()}`);
  continue;
}

    try {
      const chunkStart = Date.now();
      statusDiv.innerHTML = `
        <strong>Translating:</strong> ${currentSlug} <br>
        <strong>Previous:</strong> ${prevSlug || "N/A"} <br>
        <strong>Progress:</strong> ${doneCount}/${total} (${((doneCount/total)*100).toFixed(1)}%) <br>
        <strong>Elapsed:</strong> ${formatTime((Date.now() - startTime)/1000)} <br>
        <strong>ETA:</strong> calculating... <br>
        <strong>Speed:</strong> calculating...
      `;

      await handleTranslateAndUpdate(pageId, targetLang);
      doneCount++;

      const chunkEnd = Date.now();
      const lastDuration = (chunkEnd - chunkStart) / 1000; // in seconds
      const elapsed = (chunkEnd - startTime) / 1000;
      const speed = lastDuration.toFixed(1);
      const eta = ((elapsed / doneCount) * (total - doneCount)).toFixed(1);

      statusDiv.innerHTML = `
        <strong>Translating:</strong> ${currentSlug} <br>
<strong>Previous:</strong> ${prevSlug 
  ? `<a href="https://contenthub.guru/page/${prevSlug}.html" target="_blank">${prevSlug}</a>` 
  : "N/A"} <br>
        <strong>Progress:</strong> ${doneCount}/${total} (${((doneCount/total)*100).toFixed(1)}%) <br>
        <strong>Elapsed:</strong> ${formatTime(elapsed)} <br>
        <strong>ETA:</strong> ${formatTime(eta)} <br>
        <strong>Last page time:</strong> ${speed}s
      `;

      prevSlug = currentSlug;

      // Wait 60s before next
      for (let i = 60; i > 0; i--) {
        statusDiv.innerHTML += `<br>⏳ Waiting ${i}s before next page...`;
        await new Promise(res => setTimeout(res, 1000));
      }

    } catch (err) {
      log(`❌ Error on ${currentSlug}: ${err.message}`);
    }
  }

  statusDiv.innerHTML = `🎉 Finished safe translation of ${doneCount}/${total} pages into ${targetLang.toUpperCase()}`;
  await loadPages();
});

// Helper to format seconds into mm:ss
function formatTime(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}m ${secs}s`;
}


  /* ---------------- Start ---------------- */
  loadPages();
</script>
</body>
</html>
