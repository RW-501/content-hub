<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>
<meta name="description" content="Manage your pages, add tags, keywords, and monitor page performance.">
<meta name="keywords" content="CMS, Admin, Dashboard, Keywords, Tags, SEO, Pages">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Favicons -->
<link rel="apple-touch-icon" sizes="180x180" href="https://contenthub.guru/images/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://contenthub.guru/images/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://contenthub.guru/images/favicons/favicon-16x16.png">
<link rel="manifest" href="https://contenthub.guru/images/favicons/site.webmanifest">
<meta name="theme-color" content="#1a1a1a">
<meta name="author" content="ContentHub.guru">

<style>
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; background:#f4f6f8; color:#333; }
  h2,h3 { color:#357ABD; }
  .hidden { display:none; }
  header, footer { background:#357ABD; color:white; padding:1rem 2rem; display:flex; justify-content:space-between; align-items:center; }
  footer a { color:white; text-decoration:underline; }
  main { max-width:1200px; margin:2rem auto; padding:0 1rem; }
  button { cursor:pointer; border:none; border-radius:6px; padding:0.5rem 1rem; background:#4a90e2; color:white; font-weight:600; transition:0.3s; }
  button:hover { background:#357ABD; }
  input, textarea, select { width:100%; padding:0.5rem; margin:0.3rem 0; border-radius:6px; border:1px solid #ccc; }
  #createPageSection { background:white; padding:1.5rem; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.08); margin-bottom:2rem; }
  .dashboard-tools { display:flex; flex-wrap:wrap; gap:1rem; margin-bottom:1rem; align-items:center; }
  .dashboard-tools input, .dashboard-tools select { flex:1; min-width:150px; }
  table { width:100%; border-collapse: collapse; margin-top:1rem; background:white; border-radius:12px; overflow:hidden; box-shadow:0 4px 10px rgba(0,0,0,0.05); }
  th, td { padding:0.8rem 1rem; text-align:left; }
  th { background:#f4f4f4; }
  tr:nth-child(even) { background:#f9f9f9; }
  img { max-width:60px; border-radius:6px; }
 .siteImage { max-width: 100%; border-radius:6px; }
  .status-online { color:green; font-weight:bold; }
  .status-offline { color:red; font-weight:bold; }
  .tag { display:inline-block; background:#357ABD; color:white; padding:0.2rem 0.5rem; margin:0.2rem; border-radius:4px; font-size:0.8rem; }
 

 /* Modal styles */
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:1000; }
.modal-content { background:#fff; padding:20px; border-radius:10px; width:90%; max-width:800px; max-height:90%; overflow-y:auto; box-shadow:0 4px 20px rgba(0,0,0,0.2);}
.close-modal { float:right; font-size:24px; cursor:pointer; }
.analytics-card { display:flex; justify-content:space-between; padding:10px; border:1px solid #ddd; border-radius:6px; margin-bottom:10px; background:#f9f9f9; }
.analytics-card h3 { margin:0; font-size:16px; }
.analytics-table { width:100%; border-collapse:collapse; margin-top:10px; }
.analytics-table th, .analytics-table td { border:1px solid #ddd; padding:8px; text-align:left; }
.analytics-table th { background:#f0f0f0; }
.group {
    background-color: #7c7c7c;
    display: grid;
    padding: .5rem;
    width: 100%;
    border-radius: .5rem;
}
.row { display: grid; }
    
/* Optional styles for highlighting sorted columns */
.sorted-asc::after {
  content: " ▲";
  font-size: 0.7em;
  color: #333;
}
.sorted-desc::after {
  content: " ▼";
  font-size: 0.7em;
  color: #333;
}

.action-buttons, .share-buttons {
  display: flex;
  gap: 6px;
  margin: 4px 0;
  flex-wrap: wrap;
}

.action-buttons button {
  padding: 4px 8px;
  font-size: 13px;
  border-radius: 6px;
  cursor: pointer;
}

.share-buttons button {
  padding: 4px 6px;
  font-size: 14px;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  line-height: 1;
  text-align: center;
  cursor: pointer;
}

    
    </style>
</head>
<body>

<div id="admin-header"></div>

<script type="module">
  import { loadAdminHeader } from 'https://contenthub.guru/admin/exports/adminHeader.js';

  // Call the function to render the admin header
  loadAdminHeader('admin-header');
</script>


<main>
  <div id="auth-section">
    <h3>Login</h3>
    <button id="googleLogin">Login with Google</button>
    <div style="margin-top:10px;">
      <input id="phoneInput" placeholder="Enter phone" />
      <button id="sendCode">Send Code</button>
    </div>
    <div id="codeSection" class="hidden">
      <input id="verifyCode" placeholder="Enter code" />
      <button id="verifyBtn">Verify</button>
    </div>
    <div id="recaptcha-container"></div>
  </div>

  <div id="admin-panel" class="hidden">
    <section id="createPageSection">
      <h3>Create New Page</h3>
  <label>Title:</label>
  <input id="title" type="text"  placeholder="Page Title" />
  <div id="titleFeedback" class="seo-feedback"></div>

<div>
  <label>Description:</label>
  <textarea id="description"  placeholder="Page Description"></textarea>
  <div id="descriptionFeedback" class="seo-feedback"></div>
</div>

<div>
  <label>Keywords:</label>
  <input id="keywords" type="text" placeholder="Comma separated keywords" />
  <div id="keywordsFeedback" class="seo-feedback"></div>
</div>

<div>
  <label>Domain:</label>
  <input id="domain" type="text" value="contenthub.guru" placeholder="Page Domain (example.com)" />
</div>

<div>
  <label>Slug:</label>
  <input id="slug" type="text" placeholder="Page Domain (example.com)" />
</div>

<div style="margin-top:10px;">
  <div style="font-weight:bold;">SEO Score:</div>
  <div style="width:100%; background:#eee; height:20px; border-radius:4px;">
    <div id="seoScoreBar" style="width:0%; height:100%; background:green; border-radius:4px;"></div>
  </div>
  <div id="seoScoreText" style="font-size:12px; font-weight:bold; margin-top:2px;"></div>
</div>

<style>
  .seo-feedback {
    height: 12px;
    margin-bottom: 2px;
    font-size: 12px;
    font-weight: bold;
  }
</style>


<!-- Image Upload Section -->
<div id="imageUploadSection" style="margin-top:0.5rem;">
  <label for="imageInput" style="display:block; font-weight:600; margin-bottom:0.3rem;">Page Image</label>
  <div id="imageDropZone" 
       style="border: 2px dashed #ccc; border-radius: 8px; padding: 1rem; text-align:center; cursor:pointer; background:#fafafa;">
    <p>Drag & Drop an image here or click to select</p>
    <input type="file" id="imageInput" accept="image/*" style="display:none;" />
  </div>
  <div id="imagePreview" style="margin-top:0.5rem;">
    <img id="previewImg" src="https://contenthub.guru/images/placeholder.png" alt="Image Preview" style="max-width:200px; border-radius:6px; display:none;" />
  </div>
  <input id="imageUrl" placeholder="Page Image URL"  hidden/>
</div>

      <select id="schemaType">
        <option value="Article">Article</option>
        <option value="FAQ">FAQ</option>
        <option value="HowTo">How-To</option>
      </select>

          <!-- New Category Dropdown -->
    <div class="row">
      <label for="category">Category</label>
<select id="category">
  <option value="">-- Select Category --</option>
  <option value="general">General</option>
    <option value="guides">Guides</option>
      <option value="content_creation_basics">1. Content Creation Basics</option>
  <option value="writing_blogging">2. Writing & Blogging</option>
  <option value="social_media">3. Social Media Content</option>
  <option value="seo_organic">4. SEO & Organic Traffic</option>
  <option value="content_monetization">5. Content Monetization</option>
  <option value="multimedia">6. Multimedia Content</option>
  <option value="advanced_strategy">7. Advanced Content Strategy</option>
  <option value="tools_resources">8. Tools, Resources & Case Studies</option>
  <option value="business_content">9. Content for Businesses</option>
  <option value="future_content">10. Future of Content Creation</option>

  <option value="personal-development">Personal Development</option>
  <option value="travel">Travel</option>
  <option value="food">Food & Recipes</option>
  <option value="entertainment">Entertainment</option>
  <option value="people">People</option>

  <option value="health">Health</option>
  <option value="nutrition">Nutrition</option>
  <option value="fitness">Fitness</option>
  <option value="business">Business</option>
  <option value="tech">Technology</option>
  <option value="lifestyle">Lifestyle</option>
  <option value="education">Education</option>
  <option value="finance">Finance</option>
  <option value="news">News</option>

  <option value="sports">Sports</option>
  <option value="science">Science</option>
  <option value="gaming">Gaming</option>
  <option value="fashion">Fashion</option>
  <option value="beauty">Beauty</option>
  <option value="parenting">Parenting</option>
  <option value="pets">Pets & Animals</option>
  <option value="art">Art & Culture</option>
  <option value="politics">Politics</option>
  <option value="environment">Environment</option>
</select>

    </div>

      <div id="keywordTags" style="margin-top:0.5rem;"></div>
      <button id="createBtn">Create Page</button>
    </section>

    <div class="group">

<div id="pageArea">   
  <div class="row dashboard-tools">
    <label for="searchInput">Search</label>
    <input id="searchInput" placeholder="Search by title, domain, keyword..." />
  </div>

  <div class="row">
    <label for="searchCategory">Category</label>
    <select id="searchCategory">
      <option value="">-- All Categories --</option>
    </select>
  </div>

  <button id="updateBTN">Update</button>

  <div id="dashboardContent"></div>
</div>


  </div>
      </div>

</main>



<!-- Popup Modal -->
<div id="analyticsModal" class="modal">
  <div class="modal-content">
    <span class="close-modal">&times;</span>
    <h2>Page Analytics</h2>
    <div id="analyticsContent">Loading...</div>
  </div>
</div>

<div id="admin-footer"></div>
<script type="module">
  import { loadFooter } from 'https://contenthub.guru/admin/exports/adminFooter.js';
  loadFooter(); // injects footer into div#admin-footer
</script>



<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, RecaptchaVerifier, signInWithPhoneNumber, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getFirestore, collection, getDoc, setDoc, doc, query, updateDoc, arrayUnion, limit, where, getDocs, increment, orderBy, addDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";


import { updatePage } from "https://contenthub.guru/admin/exports/pageUpdater.js";
import { showToast } from "https://contenthub.guru/exports/showToast.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBXZcSYdspfi2jBipwUFeNmKZgU02ksg8c",
  authDomain: "contentmanagement-8af61.firebaseapp.com",
  projectId: "contentmanagement-8af61",
  storageBucket: "contentmanagement-8af61.firebasestorage.app",
  messagingSenderId: "579537581112",
  appId: "1:579537581112:web:736c7faafaf1391ce1e2cd",
  measurementId: "G-ZPWGF7YMPE"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);
let currentUser;

// Allowed emails/phones
const allowedEmails = ["1988lrp@gmail.com"];
const allowedPhones = ["+19725977878","+12145527280"];

// Auth state
onAuthStateChanged(auth, async (user) => {
  if (user && (allowedEmails.includes(user.email) || allowedPhones.includes(user.phoneNumber))) {
    currentUser = user;
    await showAdminPanel(user);
  } else if (user) logoutUser();
});

// Logout
function logoutUser() {
  signOut(auth);
  currentUser = null;
  document.getElementById("auth-section").classList.remove("hidden");
  document.getElementById("admin-panel").classList.add("hidden");
  document.getElementById("logoutBtn").classList.add("hidden");
}
document.getElementById("logoutBtn").addEventListener("click", logoutUser);

// Google Login
document.getElementById("googleLogin").addEventListener("click", async () => {
  try {
    const result = await signInWithPopup(auth, new GoogleAuthProvider());
    if (!allowedEmails.includes(result.user.email)) return logoutUser();
    currentUser = result.user;
    await showAdminPanel(currentUser);
  } catch (err) { alert(err.message); }
});

// Phone login
let recaptchaVerifier;
document.addEventListener("DOMContentLoaded", () => {
  recaptchaVerifier = new RecaptchaVerifier("recaptcha-container", { size: "invisible" }, auth);
  recaptchaVerifier.render();
});

document.getElementById("sendCode").addEventListener("click", async () => {
  let phone = document.getElementById("phoneInput").value.trim();
  if (!phone.startsWith("+")) phone = "+1" + phone;
  if (!allowedPhones.includes(phone)) return alert("Unauthorized phone number.");
  try {
    const confirmationResult = await signInWithPhoneNumber(auth, phone, recaptchaVerifier);
    window.confirmationResult = confirmationResult;
    document.getElementById("codeSection").classList.remove("hidden");
  } catch (err) { alert(err.message); }
});

document.getElementById("verifyBtn").addEventListener("click", async () => {
  try {
    const user = (await window.confirmationResult.confirm(document.getElementById("verifyCode").value.trim())).user;
    if (!allowedPhones.includes(user.phoneNumber)) return logoutUser();
    currentUser = user;
    await showAdminPanel(user);
  } catch { alert("Invalid code."); }
});

// Show admin panel
async function showAdminPanel(user) {
  document.getElementById("auth-section").classList.add("hidden");
  document.getElementById("admin-panel").classList.remove("hidden");
  document.getElementById("logoutBtn").classList.remove("hidden");
  await loadDashboard(true);
}


const checkedDomains = {};
const versions = {}; // { siteId: "V########" | null }

/* ---- helpers ---- */
function extractVersion(input) {
  if (!input) return null;
  const m = String(input).match(/V+(\d{6,})/i);
  return m ? `V${m[1]}` : null;
}

function versionToNumber(v) {
  const clean = extractVersion(v);
  return clean ? parseInt(clean.slice(1), 10) || 0 : 0;
}

function getLatestVersionNumber(versionsObj) {
  const nums = Object.values(versionsObj).map(versionToNumber).filter(n => n > 0);
  return nums.length ? Math.max(...nums) : 0;
}

function formatVersion(n) {
  return n > 0 ? `V${n}` : null;
}

/* ---- network ---- */
async function pingSite(domain) {
  if (!domain) return { online: false, version: null };

  const url = domain.startsWith("http") ? domain : `https://contenthub.guru/site/${domain}`;
  if (checkedDomains.hasOwnProperty(url)) return checkedDomains[url];

  try {
    const resp = await fetch(url, { method: "GET", cache: "no-store" });
    const isOnline = resp.ok;

    let version = null;
    if (isOnline) {
      const html = await resp.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");
      const meta = doc.querySelector('meta[name="version"]');
      if (meta) {
        version = extractVersion(meta.getAttribute("content"));
      }
    }

    const result = { online: isOnline, version };
    checkedDomains[url] = result;
    return result;
  } catch {
    const result = { online: false, version: null };
    checkedDomains[url] = result;
    return result;
  }
}

/* ---- new flow ---- */

// Step 1: Ping all pages first
async function fetchAllPages(pages) {
  for (const p of pages) {
    const { online, version } = await pingSite(p.slug);
    versions[p.siteId] = version;
    p.online = online;
    p.version = version;
  }
}

// Step 2: Get the global latest version
function getLatestVersion() {
  const latestNum = getLatestVersionNumber(versions);
  return formatVersion(latestNum);
}

// Step 3: Update DOM for each page against the global latest
function renderPageStatus(p, latestVersion) {
  const statusEl  = document.getElementById(`status-${p.siteId}`);
  const versionEl = document.getElementById(`version-${p.siteId}`);
  if (!statusEl) return;

  if (!p.online) {
    statusEl.textContent = "❌ Offline";
    statusEl.className = "status-offline";
    if (versionEl) versionEl.textContent = "";
    return;
  } else {
    statusEl.textContent = "✅ Online";
    statusEl.className = "status-online";
  }

  if (!p.version) {
    versionEl.textContent = "⚠️ No version tag";
    versionEl.className = "status-warning";
  } else if (p.version === latestVersion) {
    versionEl.textContent = `✅ Latest (${p.version})`;
    versionEl.className = "status-latest";
  } else {
    versionEl.textContent = `⚠️ Outdated (${p.version})`;
    versionEl.className = "status-warning";
  }

  console.log("version:", p.version, "latestVersion:", latestVersion);
}

// Step 4: Orchestrate
async function updateAllPages(pages) {
  await fetchAllPages(pages);
  const latestVersion = getLatestVersion();
  console.log("🔥 Final latest version:", latestVersion);

  for (const p of pages) {
    renderPageStatus(p, latestVersion);
  }
}

const imageInput = document.getElementById("imageInput");
const imageDropZone = document.getElementById("imageDropZone");
const previewImg = document.getElementById("previewImg");
const imageUrl = document.getElementById("imageUrl");

// Open file selector on drop zone click
imageDropZone.addEventListener("click", () => imageInput.click());

// Handle file selection
imageInput.addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  try {
    // Upload to Firebase Storage
    const fileRef = ref(storage, `page-images/${Date.now()}-${file.name}`);
    await uploadBytes(fileRef, file);
    const url = await getDownloadURL(fileRef);

    // Show preview
    previewImg.src = url;
    previewImg.style.display = "block";

    // Save only URL for Firestore
    imageUrl.value = url;
  } catch (err) {
    console.error("Upload failed:", err);
    alert("Image upload failed");
  }
});

// Drag & Drop functionality
imageDropZone.addEventListener("dragover", (e) => {
  e.preventDefault();
  imageDropZone.style.borderColor = "#357ABD";
  imageDropZone.style.background = "#f0f4fa";
});

imageDropZone.addEventListener("dragleave", (e) => {
  e.preventDefault();
  imageDropZone.style.borderColor = "#ccc";
  imageDropZone.style.background = "#fafafa";
});

imageDropZone.addEventListener("drop", async (e) => {
  e.preventDefault();
  imageDropZone.style.borderColor = "#ccc";
  imageDropZone.style.background = "#fafafa";

  const file = e.dataTransfer.files[0];
  if (!file) return;

  try {
    const fileRef = ref(storage, `page-images/${Date.now()}-${file.name}`);
    await uploadBytes(fileRef, file);
    const url = await getDownloadURL(fileRef);

    previewImg.src = url;
    previewImg.style.display = "block";
    imageUrl.value = url;
  } catch (err) {
    console.error("Upload failed:", err);
    alert("Image upload failed");
  }
});


// Create Page button
document.getElementById("createBtn").addEventListener("click", async () => {
  // Gather input values
  const title = document.getElementById("title").value.trim();
  const description = document.getElementById("description").value.trim();
  const domain = document.getElementById("domain").value.trim();
  const slug = document.getElementById("slug").value.trim();
  const image = document.getElementById("imageUrl").value.trim();
  const schemaType = document.getElementById("schemaType").value;
  const keywords = document.getElementById("keywords").value
    .split(",")
    .map(k => k.trim())
    .filter(k => k);

const categorySelect = document.getElementById("category").value;


  if (!title || !slug) return showToast("Title and domain are required.");

  // Check if domain already exists in Firestore
  const q = query(
    collection(db, "pages"),
    where("slug", "==", slug) // check the slug field
  );

const querySnapshot = await getDocs(q);

if (!querySnapshot.empty) {
  return showToast("error", "Domain already exists. Choose a different one.", 5000);
}

/*
  // Ping the domain to check if live
  const isLive = await pingSite(slug);
  if (!isLive) {
    showToast("warning", "Domain seems offline or unreachable. You can still create it.");
  }
*/
  const pageName = slug; // Date.now().toString();
  const jsTimestamp = Date.now(); // numeric timestamp for users.createdPages


  // 🔽 Get 4 lowest viewed pages (same category optional)
  let suggested = [];
  let sq;
  if (categorySelect) {
    sq = query(
      collection(db, "pages"),
      where("category", "==", categorySelect),
      orderBy("views", "asc"),
      limit(4)
    );
  } else {
    sq = query(collection(db, "pages"), orderBy("views", "asc"), limit(4));
  }

const sSnap = await getDocs(sq);
sSnap.forEach((docSnap) => {
  const d = docSnap.data();
  suggested.push({
    id: docSnap.id,
    image: d.image || null,
    title: d.title || "",
    category: d.category || "",
    description: d.description || "",
    slug: d.slug || ""
  });
});



  // Build page object for Firestore
  const newPage = {
    title,
    description,
    suggested,
    domain,
    slug,
    image,
    schemaType,
    keywords,
    category: categorySelect,
    tags: keywords,
    pageName,
    userID: currentUser.uid,
    createdBy: currentUser.uid,
    body: "",
    sections: [],
    moderators: [],
    gTag: "G-ZPWGF7YMPE",
    adsense: "ca-pub-2001518155292747",
    type: "page",
    status: "draft",
    createdAt: serverTimestamp(), // Firestore timestamp
    updatedAt: serverTimestamp(),
    publishedCount: 0,
    views: 0,
    uniqueViews: 0
  };

  try {
    // Save to Firestore pages collection
    const docRef = await addDoc(collection(db, "pages"), newPage);
    await updateDoc(doc(db, "pages", docRef.id), { siteId: docRef.id });

    const selectedCategory = document.getElementById("category").value;

    // Add to user's createdPages array with numeric timestamp
    const userPageData = {
      id: docRef.id,
      title,
      domain,
      slug,
      pageName,
      category: selectedCategory,
      createdAt: jsTimestamp, // numeric timestamp for sorting/filtering
      status: "draft",
      tags: keywords,
      image
    };
    await setDoc(doc(db, "users", currentUser.uid), {
      createdPages: arrayUnion(userPageData)
    }, { merge: true });

  
    showToast("info", "Ready...");

setTimeout(() => {
  window.location = `https://contenthub.guru/admin/editor?id=${docRef.id}`;
}, 2000);

    
    // Reload dashboard
    await loadDashboard(true);

    // Update home page sitesData if available
    if (window.sitesData) {
      window.sitesData.push({ id: docRef.id, ...newPage });
      if (typeof renderSites === "function") renderSites();
    }

    // ✅ Clear inputs after creating
    document.getElementById("title").value = "";
    document.getElementById("description").value = "";
    document.getElementById("domain").value = "";
    document.getElementById("slug").value = "";
    document.getElementById("imageUrl").value = "";
    document.getElementById("category").value = "";
    document.getElementById("keywords").value = "";
    document.getElementById("schemaType").selectedIndex = 0;
    const previewImg = document.getElementById("previewImg");
    if (previewImg) { previewImg.src = ""; previewImg.style.display = "none"; }

  } catch (err) {
    console.error(err);
    showToast("error", "Error creating page: " + err.message);
  }
});

  const slugInput = document.getElementById("slug");
  const titleInput = document.getElementById("title");

// Listen for focus out (blur) event
 titleInput.addEventListener('input', () => {
    console.log("slugInput.value:", slugInput.value);

if (slugInput.value) {
    slugInput.value = titleInput.value
        .trim()                        // Remove leading/trailing spaces
        .toLowerCase()                 // Convert to lowercase
        .replace(/\s+/g, '-')          // Replace spaces with hyphens
        .replace(/[^a-z0-9\-]/g, '')   // Remove special characters except hyphens
        .replace(/-+/g, '-');          // Collapse multiple hyphens
}

});

// Listen for focus out (blur) event
 titleInput.addEventListener('click', () => {
    console.log("slugInput.value:", slugInput.value);

if (slugInput.value) {
    slugInput.value = titleInput.value
        .trim()                        // Remove leading/trailing spaces
        .toLowerCase()                 // Convert to lowercase
        .replace(/\s+/g, '-')          // Replace spaces with hyphens
        .replace(/[^a-z0-9\-]/g, '')   // Remove special characters except hyphens
        .replace(/-+/g, '-');          // Collapse multiple hyphens
}

});
// JS for Modal
const modal = document.getElementById("analyticsModal");
const modalClose = modal.querySelector(".close-modal");
document.getElementById("showAnalytics").addEventListener("click", async () => {
  modal.style.display = "flex";
  await loadAnalytics();
});
modalClose.onclick = () => modal.style.display = "none";
window.onclick = (e) => { if(e.target === modal) modal.style.display = "none"; };

// 🔹 Load analytics from Firestore
async function loadAnalytics() {
  const contentDiv = document.getElementById("analyticsContent");
  contentDiv.innerHTML = "Loading...";

  try {
    const userSnap = await getDoc(doc(db, "users", currentUser.uid));
    const pages = userSnap.exists() ? userSnap.data().createdPages || [] : [];
    if (!pages.length) { 
      contentDiv.innerHTML = "<p>No pages yet.</p>"; 
      return; 
    }

    // 🔹 Fetch pages + locations in parallel
    const results = await Promise.all(
      pages.map(async (p) => {
        const [pageSnap, locSnap] = await Promise.all([
          getDoc(doc(db, "pages", p.id)),
          getDoc(doc(db, "page_locations", p.id))
        ]);
        return { 
          slug: p.slug, 
          data: pageSnap.exists() ? pageSnap.data() : {}, 
          loc: locSnap.exists() ? locSnap.data() : {} 
        };
      })
    );

    // 🔹 Build HTML
    let html = results.map(({ slug, data, loc }) => {
      let block = `
        <div class="analytics-card">
          <h3>${slug}</h3><br>
          <p>Total Views: ${data.views || 0}</p>
          <p>Unique Visitors Today: ${Object.keys(loc.cities || {}).length || 0}</p>
        </div>
      `;

      if (loc.countries && loc.regions && loc.cities) {
        block += `
          <table class="analytics-table">
            <thead><tr><th>Country</th><th>Region</th><th>City</th><th>Visitors</th></tr></thead>
            <tbody>
              ${Object.entries(loc.cities).map(([city, count]) => {
                const region = Object.keys(loc.regions || {})[0] || "-";
                const country = Object.keys(loc.countries || {})[0] || "-";
                return `<tr><td>${country}</td><td>${region}</td><td>${city}</td><td>${count}</td></tr>`;
              }).join("")}
            </tbody>
          </table>
        `;
      }
      return block;
    }).join("");

    contentDiv.innerHTML = html;
  } catch (err) {
    contentDiv.innerHTML = `<p>Error loading analytics: ${err.message}</p>`;
    console.error(err);
  }
}

window.loadAnalytics = loadAnalytics;


let sortState = { field: null, asc: true };

async function loadDashboard(autoPing = false) {
  console.log("autoPing  ", autoPing);

  const dashboardContent = document.getElementById("dashboardContent");
  const userSnap = await getDoc(doc(db, "users", currentUser.uid));
  const data = userSnap.exists() ? userSnap.data().createdPages || [] : [];

  if (!data.length) {
    dashboardContent.innerHTML = "<p>No pages yet.</p>";
    return;
  }

  console.log("📊 loadDashboard called with data:", data);

  let html = `<table>
    <thead>
      <tr>
        <th>Preview</th>
        <th class="sortable" data-field="title">Domain</th>
        <th class="sortable" data-field="category">Category</th>
        <th>Status</th>
        <th>Version</th>
        <th class="sortable" data-field="views">Views</th>
        <th>Actions</th>
      </tr>
    </thead><tbody>`;

  data.forEach((pageData, index) => {
    console.log(`🔎 Rendering row ${index}`, pageData);

    const pageUrl = `https://contenthub.guru/site/${pageData.slug}`;
    const shareText = encodeURIComponent(`Check out this page: ${pageData.title || ''}`);

    html += `<tr>
      <td><a href="${pageUrl}" target="_blank">
        <img class='siteImage' src="${pageData.image || 'https://contenthub.guru/images/placeholder.png'}" 
             alt="preview" width="300" height="200">
      </a></td>
      <td>${pageData.title || ''}</td>
      <td>${pageData.category || ''}</td>
      <td><div id="status-${pageData.siteId}" class="status-offline">❌ Offline</div></td>
      <td><div id="version-${pageData.siteId}" class="version">version</div></td>
      <td>${pageData.views || 0}</td>
      <td>
        <div class="action-buttons">
          <button class='updatePageBTN' onclick="updatePageBtn('${pageData.siteId}','${pageData.slug}', '${pageData.category}')">Update</button>
          <button onclick="window.open('https://contenthub.guru/admin/editor?id=${pageData.siteId}', '_blank')">Edit</button>
          <button class="remove-btn" onclick="removePage('${pageData.siteId}','${pageData.slug}')">Remove</button>
        </div>
        <div class="share-buttons">
          <button onclick="shareOnTwitter('${pageUrl}', '${shareText}')">🐦</button>
          <button onclick="shareOnLinkedIn('${pageUrl}', '${shareText}')">💼</button>
          <button onclick="shareOnFacebook('${pageUrl}')">📘</button>
          <button onclick="shareOnAll('${pageUrl}', '${shareText}')">🌍</button>
        </div>
      </td>
    </tr>`;
  });

  html += "</tbody></table>";
  dashboardContent.innerHTML = html;
  console.log("✅ Dashboard rendered with rows:", data.length);

  // Sorting logic
  document.querySelectorAll(".sortable").forEach(th => {
    th.classList.remove("sorted-asc", "sorted-desc");
    if (sortState.field === th.dataset.field) {
      th.classList.add(sortState.asc ? "sorted-asc" : "sorted-desc");
    }

    th.onclick = () => {
      if (sortState.field === th.dataset.field) {
        sortState.asc = !sortState.asc;
      } else {
        sortState.field = th.dataset.field;
        sortState.asc = true;
      }

      const sorted = [...data].sort((a, b) => {
        const valA = a[sortState.field] ?? '';
        const valB = b[sortState.field] ?? '';
        if (valA < valB) return sortState.asc ? -1 : 1;
        if (valA > valB) return sortState.asc ? 1 : -1;
        if (sortState.field !== 'title') {
          const titleA = a.title ?? '';
          const titleB = b.title ?? '';
          if (titleA < titleB) return -1;
          if (titleA > titleB) return 1;
        }
        return 0;
      });

      loadDashboard(sorted);
    };
  });

  // 🔥 Auto-ping logic
  if (autoPing) {
    console.log("🚀 Auto-pinging all pages for status + version check...");
    await updateAllPages(data);
  }
}



function shareOnAll(url, text) {


   shareNative(url, text);

   return;

  // Twitter
  const twitterUrl = `https://twitter.com/intent/tweet?text=${text}&url=${encodeURIComponent(url)}`;
  window.open(twitterUrl, '_blank', 'width=600,height=400');

  // LinkedIn
  const linkedinUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}&title=${text}`;
  window.open(linkedinUrl, '_blank', 'width=600,height=400');

  // Facebook
  const fbUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
  window.open(fbUrl, '_blank', 'width=600,height=400');
}

window.shareOnAll = shareOnAll;

function shareNative(url, text) {
  if (navigator.share) {
    navigator.share({
      title: text,
      text: text,
      url: url
    }).catch(err => console.error("Share failed:", err));
  } else {
    alert("Native share not supported in this browser.");
  }
}


function shareOnTwitter(url, text) {
  const twitterUrl = `https://twitter.com/intent/tweet?text=${text}&url=${encodeURIComponent(url)}`;
  window.open(twitterUrl, '_blank', 'width=600,height=400');
}

function shareOnLinkedIn(url, text) {
  const linkedinUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}&title=${text}`;
  window.open(linkedinUrl, '_blank', 'width=600,height=400');
}

function shareOnFacebook(url) {
  const fbUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
  window.open(fbUrl, '_blank', 'width=600,height=400');
}

window.shareOnTwitter = shareOnTwitter;
window.shareOnLinkedIn = shareOnLinkedIn;
window.shareOnFacebook = shareOnFacebook;

async function updatePageBtn(siteId, slug, category) {
  try {
    // 🔽 Get 4 lowest viewed pages (same category optional)
    let suggested = [];
    let sq;
    if (category) {
      sq = query(
        collection(db, "pages"),
        where("category", "==", category),
        orderBy("views", "asc"),
        limit(4)
      );
    } else {
      sq = query(
        collection(db, "pages"),
        orderBy("views", "asc"),
        limit(4)
      );
    }

    const sSnap = await getDocs(sq);
    sSnap.forEach((docSnap) => {
      suggested.push({
        id: docSnap.id,
        ...docSnap.data()
      });
    });

    const updateData = {
      suggested,
      publishedCount: increment(1),
      status: "published",
      updatedAt: serverTimestamp()
    };

    // ✅ Update Firestore
    await setDoc(doc(db, "pages", siteId), updateData, { merge: true });

    // ✅ Fetch the updated page
    const docSnap = await getDoc(doc(db, "pages", siteId));
    if (!docSnap.exists()) {
      console.error("No page data found for:", siteId);
      return;
    }
    const articleData = docSnap.data();

    // ✅ Update UI row dynamically
      updatePage(articleData);

    showToast("success", "Page updated!", 2500);

  } catch (err) {
    console.error("Error updating page:", err);
    alert("Failed to update page.");
  }
}

window.updatePageBtn = updatePageBtn;

// Remove page function
async function removePage(pageId, domain) {
  if (!confirm(`Are you sure you want to remove the page "${domain}"?`)) return;

  try {
    // 1️⃣ Remove page doc from "pages" collection
    await deleteDoc(doc(db, "pages", pageId));

    // 2️⃣ Remove page from user's createdPages array
    const userRef = doc(db, "users", currentUser.uid);
    const userSnap = await getDoc(userRef);
    if (userSnap.exists()) {
      const createdPages = userSnap.data().createdPages || [];
      const updatedPages = createdPages.filter(p => p.id !== pageId);
      await updateDoc(userRef, { createdPages: updatedPages });
    }


    // Randomized or complex approach
const parts = ['p', 'h', 'g'];
const randomizePart = (part) => {
    return part.split('').reverse().join('');
};

const part_1 = randomizePart(parts.join(''));
const part_2 = "_akXGrO51HwgEI";
const part_3 = "VWzDIghLbIE";
const part_4 = "G9MnTu0fIjKj";

const token = part_1 + part_2 + part_3 + part_4;

    // 3️⃣ Remove page from GitHub
    const owner = "RW-501", repo = "content-hub";
    const filePath = `site/${domain}.html`;
    const branch = "main";
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`;

    // Get file SHA first
    const fileResp = await fetch(url, { 
      method: "GET", 
      headers: { Authorization: `Bearer ${token}`, 'Accept':'application/vnd.github+json' } 
    });

    if (fileResp.ok) {
      const sha = (await fileResp.json()).sha;
      const deleteResp = await fetch(url, {
        method: "DELETE",
        headers: { Authorization: `Bearer ${token}`, 'Content-Type':'application/json', Accept:'application/vnd.github+json' },
        body: JSON.stringify({
          message: `Delete ${filePath}`,
          sha,
          branch
        })
      });
      if (!deleteResp.ok) throw new Error((await deleteResp.json()).message);
    }

    showToast("info", `Page "${domain}" removed successfully.`);
    await loadDashboard(true);

  } catch (err) {
    console.error(err);
    showToast("error", `Error removing page: ${err.message}`);
  }
}

window.removePage = removePage;


document.addEventListener("DOMContentLoaded", () => {
  const titleInput = document.getElementById("title");
  const descriptionInput = document.getElementById("description");
  const keywordsInput = document.getElementById("keywords");
  const domainInput = document.getElementById("domain");

  const titleFeedback = document.getElementById("titleFeedback");
  const descriptionFeedback = document.getElementById("descriptionFeedback");
  const keywordsFeedback = document.getElementById("keywordsFeedback");
  const seoScoreBar = document.getElementById("seoScoreBar");
  const seoScoreText = document.getElementById("seoScoreText");

  const stopWords = ["a","an","and","the","is","of","to","in","for","on","at","by","with","from","or","as","be","this","that","it"];

  const seoRubric = {
    title: { min: 50, max: 70 },          // chars
    description: { min: 150, max: 160 },  // chars
    keywords: { min: 5, max: 15 }         // count
  };

  function evaluateSEOLength(count, min, max) {
    if (count < min) return 0;      // bad
    if (count > max) return 50;     // okay
    return 100;                     // good
  }

  function countKeywordMatches(text, keywords) {
    if (!text || !keywords) return 0;
    const words = text.toLowerCase().split(/\s+/);
    const keyList = keywords.toLowerCase().split(/\s*,\s*/);
    return words.reduce((acc, word) => acc + (keyList.includes(word) ? 1 : 0), 0);
  }

  function generateKeywords(text) {
    return text
      .toLowerCase()
      .split(/\s+/)
      .map(word => word.replace(/[^a-z0-9]/g, ""))
      .filter(word => word && !stopWords.includes(word) && !/^\d+$/.test(word))
      .join(", ");
  }

  function generateDomain(text) {
    return text
      .toLowerCase()
      .replace(/\s+/g, "-")
      .replace(/[^a-z0-9\-]/g, "");
  }

  function updateSEOIndicators() {

    
if (slugInput.value) {
    slugInput.value = titleInput.value
        .trim()                        // Remove leading/trailing spaces
        .toLowerCase()                 // Convert to lowercase
        .replace(/\s+/g, '-')          // Replace spaces with hyphens
        .replace(/[^a-z0-9\-]/g, '')   // Remove special characters except hyphens
        .replace(/-+/g, '-');          // Collapse multiple hyphens
}

    const title = titleInput.value.trim();
    const description = descriptionInput.value.trim();
    const keywords = keywordsInput.value.trim();

    const titleCount = title.length;
    const descCount = description.length;
    const keywordCount = keywords.split(/\s*,\s*/).filter(Boolean).length;

    // Evaluate each part (0–100)
    const titleScore = evaluateSEOLength(titleCount, seoRubric.title.min, seoRubric.title.max);
    const descScore = evaluateSEOLength(descCount, seoRubric.description.min, seoRubric.description.max);
    const keywordsScore = evaluateSEOLength(keywordCount, seoRubric.keywords.min, seoRubric.keywords.max);

    // Average SEO score
    const seoScore = Math.round((titleScore + descScore + keywordsScore) / 3);

    // Update score bar
    seoScoreBar.style.width = `${seoScore}%`;
    seoScoreBar.style.background = seoScore >= 80 ? "green" : seoScore >= 50 ? "orange" : "red";
    seoScoreText.textContent = `SEO Score: ${seoScore}/100`;

    // Feedback text
    titleFeedback.style.color = titleScore === 100 ? "green" : titleScore === 50 ? "orange" : "red";
    descriptionFeedback.style.color = descScore === 100 ? "green" : descScore === 50 ? "orange" : "red";
    keywordsFeedback.style.color = keywordsScore === 100 ? "green" : keywordsScore === 50 ? "orange" : "red";

    titleFeedback.textContent = `Title: ${titleCount} chars`;
    descriptionFeedback.textContent = `Description: ${descCount} chars`;
    keywordsFeedback.textContent = `Keywords: ${keywordCount}`;

    // Keyword match suggestions
    const titleMatches = countKeywordMatches(title, keywords);
    const descMatches = countKeywordMatches(description, keywords);

    if(titleMatches < 1) titleFeedback.textContent += " ⚠ Add keywords in title!";
    if(descMatches < 2) descriptionFeedback.textContent += " ⚠ Add keywords in description!";
  }

  titleInput.addEventListener("input", () => {
    if (!domainInput.value.trim()) domainInput.value = generateDomain(titleInput.value);
    if (!keywordsInput.value.trim()) keywordsInput.value = generateKeywords(titleInput.value);
    updateSEOIndicators();
  });

  descriptionInput.addEventListener("input", updateSEOIndicators);
  keywordsInput.addEventListener("input", updateSEOIndicators);

  updateSEOIndicators();
});



titleInput.addEventListener('blur', () => {
    console.log("slugInput.value:", slugInput.value);

if (slugInput.value) {
    slugInput.value = titleInput.value
        .trim()                        // Remove leading/trailing spaces
        .toLowerCase()                 // Convert to lowercase
        .replace(/\s+/g, '-')          // Replace spaces with hyphens
        .replace(/[^a-z0-9\-]/g, '')   // Remove special characters except hyphens
        .replace(/-+/g, '-');          // Collapse multiple hyphens
}

});



async function updateOutdatedPages() {
  const updateButtons = document.querySelectorAll(".updatePageBTN");

  // Build a list of update tasks with page details
  const outdatedPages = Array.from(updateButtons).map(btn => {
    const match = btn.getAttribute("onclick")?.match(/updatePageBtn\('([^']+)','([^']+)'/);
    if (!match) return null;

    const siteId = match[1];
    const slug = match[2];
    const versionEl = document.getElementById(`version-${siteId}`);
    const titleEl = btn.closest("tr")?.querySelector("td:nth-child(2) a");

    return {
      siteId,
      slug,
      btn,
      versionEl,
      title: titleEl ? titleEl.textContent.trim() : "(No title found)",
      isOutdated: versionEl && versionEl.textContent.includes("Outdated")
    };
  }).filter(p => p !== null);

  if (outdatedPages.length === 0) {
    console.log("✅ No pages found.");
    return;
  }

  console.log(`Found ${outdatedPages.length} pages, checking for outdated versions...`);

  let index = 0;
  let updatedCount = 0;
  let skippedCount = 0;
  let errorCount = 0;

  const interval = setInterval(() => {
    if (index < outdatedPages.length) {
      const page = outdatedPages[index];

      if (page.isOutdated) {
        try {
          page.btn.click();
          console.log(`🔄 Updating: "${page.title}" (siteId: ${page.siteId}, slug: ${page.slug})`);
          updatedCount++;
        } catch (err) {
          console.error(`❌ Error updating "${page.title}" (${page.siteId}):`, err);
          errorCount++;
        }
      } else {
        console.log(`⏭️ Skipped (Up to date): "${page.title}" (siteId: ${page.siteId})`);
        skippedCount++;
      }

      index++;
    } else {
      clearInterval(interval);
      console.log("🎉 Finished checking all pages.");
      console.log(`📊 Summary: ${updatedCount} updated, ${skippedCount} skipped, ${errorCount} errors.`);
    }
  }, 3000); // 3 sec per page
}



  // Attach function to the new button
  document.getElementById("updateBTN").addEventListener("click", updateOutdatedPages);


</script>
</body>
</html>
