<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>View Pages</title>
<meta name="description" content="Manage your pages, add tags, keywords, and monitor page performance.">
<meta name="keywords" content="CMS, Admin, Dashboard, Keywords, Tags, SEO, Pages">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Favicons -->
<link rel="apple-touch-icon" sizes="180x180" href="https://contenthub.guru/images/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://contenthub.guru/images/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://contenthub.guru/images/favicons/favicon-16x16.png">
<link rel="manifest" href="https://contenthub.guru/images/favicons/site.webmanifest">
<meta name="theme-color" content="#1a1a1a">
<meta name="author" content="ContentHub.guru">

<style>
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; background:#f4f6f8; color:#333; }
  h2,h3 { color:#357ABD; }
  .hidden { display:none; }
  header, footer { background:#357ABD; color:white; padding:1rem 2rem; display:flex; justify-content:space-between; align-items:center; }
  footer a { color:white; text-decoration:underline; }
  main { max-width:1200px; margin:2rem auto; padding:0 1rem; }
  button { cursor:pointer; border:none; border-radius:6px; padding:0.5rem 1rem; background:#4a90e2; color:white; font-weight:600; transition:0.3s; }
  button:hover { background:#357ABD; }
  input, textarea, select { width:100%; padding:0.5rem; margin:0.3rem 0; border-radius:6px; border:1px solid #ccc; }
  #createPageSection { background:white; padding:1.5rem; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.08); margin-bottom:2rem; }
  .dashboard-tools { display:flex; flex-wrap:wrap; gap:1rem; margin-bottom:1rem; align-items:center; }
  .dashboard-tools input, .dashboard-tools select { flex:1; min-width:150px; }
  table { width:100%; border-collapse: collapse; margin-top:1rem; background:white; border-radius:12px; overflow:hidden; box-shadow:0 4px 10px rgba(0,0,0,0.05); }
  th, td { padding:0.8rem 1rem; text-align:left; }
  th { background:#f4f4f4; }
  tr:nth-child(even) { background:#f9f9f9; }
  img { max-width:60px; border-radius:6px; }
 .siteImage { max-width: 100%; border-radius:6px; }
  .status-online { color:green; font-weight:bold; }
  .status-offline { color:red; font-weight:bold; }
  .tag { display:inline-block; background:#357ABD; color:white; padding:0.2rem 0.5rem; margin:0.2rem; border-radius:4px; font-size:0.8rem; }
 

 /* Modal styles */
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:1000; }
.modal-content { background:#fff; padding:20px; border-radius:10px; width:90%; max-width:800px; max-height:90%; overflow-y:auto; box-shadow:0 4px 20px rgba(0,0,0,0.2);}
.close-modal { float:right; font-size:24px; cursor:pointer; }
.analytics-card { display:flex; justify-content:space-between; padding:10px; border:1px solid #ddd; border-radius:6px; margin-bottom:10px; background:#f9f9f9; }
.analytics-card h3 { margin:0; font-size:16px; }
.analytics-table { width:100%; border-collapse:collapse; margin-top:10px; }
.analytics-table th, .analytics-table td { border:1px solid #ddd; padding:8px; text-align:left; }
.analytics-table th { background:#f0f0f0; }
.group {
    background-color: #7c7c7c;
    display: grid;
    padding: .5rem;
    width: 100%;
    border-radius: .5rem;
}
.row { display: grid; }
    
/* Optional styles for highlighting sorted columns */
.sorted-asc::after {
  content: " ▲";
  font-size: 0.7em;
  color: #333;
}
.sorted-desc::after {
  content: " ▼";
  font-size: 0.7em;
  color: #333;
}

.action-buttons, .share-buttons {
  display: flex;
  gap: 6px;
  margin: 4px 0;
  flex-wrap: wrap;
}

.action-buttons button {
  padding: 4px 8px;
  font-size: 13px;
  border-radius: 6px;
  cursor: pointer;
}

.share-buttons button {
  padding: 4px 6px;
  font-size: 14px;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  line-height: 1;
  text-align: center;
  cursor: pointer;
}

    .highlight-row {
  background-color: #fffae6 !important;
  transition: background-color 0.5s ease;
}

    </style>
</head>
<body>

<div id="admin-header"></div>

<script type="module">
  import { loadAdminHeader } from 'https://contenthub.guru/admin/exports/adminHeader.js';

  // Call the function to render the admin header
  loadAdminHeader('admin-header');
</script>


<main>
  <div id="auth-section">
    <h3>Login</h3>
    <button id="googleLogin">Login with Google</button>
    <div style="margin-top:10px;">
      <input id="phoneInput" placeholder="Enter phone" />
      <button id="sendCode">Send Code</button>
    </div>
    <div id="codeSection" class="hidden">
      <input id="verifyCode" placeholder="Enter code" />
      <button id="verifyBtn">Verify</button>
    </div>
    <div id="recaptcha-container"></div>
  </div>

  <div id="admin-panel" class="hidden">

    
    <div class="group">

<div id="pageArea">   
<div class="row dashboard-tools">
  <label for="searchInput">Search</label>
  <input id="searchInput" placeholder="Search by title, domain, keyword..." />
</div>

<div class="row">
  <label for="searchCategory">Category</label>
  <select id="searchCategory">
    <option value="">-- All Categories --</option>
    <option value="people">People</option>
    <option value="general">General</option>
    <option value="guides">Guides</option>
    <option value="how_to">How Tos</option>
    <option value="guides">Guides</option>
  <option value="general">General</option>

  </select>
</div>

<div class="row">
  <label><input type="checkbox" id="filterNoImages"> No Page Image</label>
  <label><input type="checkbox" id="filterLinks"> Has Links</label>
  <label><input type="checkbox" id="filterAds"> Has Ads</label>
  <label><input type="checkbox" id="filterImages"> Has Images</label>
  <label><input type="checkbox" id="filterVideos"> Has Videos</label>
</div>

<button id="updateBTN">Update</button>
<button id="logsBTN">Logs</button>
<button id="pingBTN">Ping</button>

  <div id="dashboardContent"></div>
</div>


  </div>
      </div>

</main>



<!-- Popup Modal -->
<div id="analyticsModal" class="modal">
  <div class="modal-content">
    <span class="close-modal">&times;</span>
    <h2>Page Analytics</h2>
    <div id="analyticsContent">Loading...</div>
  </div>
</div>

<div id="admin-footer"></div>
<script type="module">
  import { loadFooter } from 'https://contenthub.guru/admin/exports/adminFooter.js';
  loadFooter(); // injects footer into div#admin-footer
</script>



<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, RecaptchaVerifier, signInWithPhoneNumber, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getFirestore, collection, getDoc, setDoc, doc, query, updateDoc, arrayUnion, limit, where, getDocs, increment, orderBy, addDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";


import { translateArticleData } from "https://contenthub.guru/admin/exports/updateArticle.js";
import { updatePage } from "https://contenthub.guru/admin/exports/pageUpdater.js";
import { showToast } from "https://contenthub.guru/exports/showToast.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBXZcSYdspfi2jBipwUFeNmKZgU02ksg8c",
  authDomain: "contentmanagement-8af61.firebaseapp.com",
  projectId: "contentmanagement-8af61",
  storageBucket: "contentmanagement-8af61.firebasestorage.app",
  messagingSenderId: "579537581112",
  appId: "1:579537581112:web:736c7faafaf1391ce1e2cd",
  measurementId: "G-ZPWGF7YMPE"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);
let currentUser;

// Allowed emails/phones
const allowedEmails = ["1988lrp@gmail.com"];
const allowedPhones = ["+19725977878","+12145527280"];

document.addEventListener("DOMContentLoaded", () => {
  // Auth state
  onAuthStateChanged(auth, async (user) => {
    if (user && (allowedEmails.includes(user.email) || allowedPhones.includes(user.phoneNumber))) {
      currentUser = user;
      await showAdminPanel(user);
    } else if (user) {
      logoutUser();
    }
  });
});

// Logout
function logoutUser() {
  signOut(auth);
  currentUser = null;
  document.getElementById("auth-section").classList.remove("hidden");
  document.getElementById("admin-panel").classList.add("hidden");
  document.getElementById("logoutBtn").classList.add("hidden");
}
document.getElementById("logoutBtn").addEventListener("click", logoutUser);

// Google Login
document.getElementById("googleLogin").addEventListener("click", async () => {
  try {
    const result = await signInWithPopup(auth, new GoogleAuthProvider());
    if (!allowedEmails.includes(result.user.email)) return logoutUser();
    currentUser = result.user;
    console.log("User ID: ",currentUser);

    await showAdminPanel(currentUser);
  } catch (err) { alert(err.message); }
});

// Phone login
let recaptchaVerifier;
document.addEventListener("DOMContentLoaded", () => {
  recaptchaVerifier = new RecaptchaVerifier("recaptcha-container", { size: "invisible" }, auth);
  recaptchaVerifier.render();
});

document.getElementById("sendCode").addEventListener("click", async () => {
  let phone = document.getElementById("phoneInput").value.trim();
  if (!phone.startsWith("+")) phone = "+1" + phone;
  if (!allowedPhones.includes(phone)) return alert("Unauthorized phone number.");
  try {
    const confirmationResult = await signInWithPhoneNumber(auth, phone, recaptchaVerifier);
    window.confirmationResult = confirmationResult;
    document.getElementById("codeSection").classList.remove("hidden");
  } catch (err) { alert(err.message); }
});

document.getElementById("verifyBtn").addEventListener("click", async () => {
  try {
    const user = (await window.confirmationResult.confirm(document.getElementById("verifyCode").value.trim())).user;
    if (!allowedPhones.includes(user.phoneNumber)) return logoutUser();
    currentUser = user;
    await showAdminPanel(user);
  } catch { alert("Invalid code."); }
});

// Show admin panel
async function showAdminPanel(user) {
  document.getElementById("auth-section").classList.add("hidden");
  document.getElementById("admin-panel").classList.remove("hidden");
  document.getElementById("logoutBtn").classList.remove("hidden");
  await loadDashboard(true);
}


const checkedDomains = {};
const versions = {}; // { siteId: "V########" | null }

/* ---- helpers ---- */
function extractVersion(input) {
  if (!input) return null;
  const m = String(input).match(/V+(\d{6,})/i);
  return m ? `V${m[1]}` : null;
}

function versionToNumber(v) {
  const clean = extractVersion(v);
  return clean ? parseInt(clean.slice(1), 10) || 0 : 0;
}

function getLatestVersionNumber(versionsObj) {
  const nums = Object.values(versionsObj).map(versionToNumber).filter(n => n > 0);
  return nums.length ? Math.max(...nums) : 0;
}

function formatVersion(n) {
  return n > 0 ? `V${n}` : null;
}

/* ---- network ---- */
async function pingSite(domain) {
  if (!domain) return { online: false, version: null, faq: null, howTo: null, links: 0, ads: 0, images: 0, videos: 0 };

  const url = domain.startsWith("http") ? domain : `https://contenthub.guru/page/${domain}`;
  if (checkedDomains.hasOwnProperty(url)) return checkedDomains[url];

  try {
    const resp = await fetch(url, { method: "GET", cache: "no-store" });
    const isOnline = resp.ok;

    let version = null;
    let faq = null;
    let howTo = null;
    let links = 0, ads = 0, images = 0, videos = 0;

    if (isOnline) {
      const html = await resp.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");

      // Extract meta info
      const metaVersion = doc.querySelector('meta[name="version"]');
      const metaFAQ = doc.querySelector('meta[name="faq"]');
      const metaHowTo = doc.querySelector('meta[name="howTo"]');
      const metaLinks = doc.querySelector('meta[name="linkCount"]');
      const metaAds = doc.querySelector('meta[name="adCount"]');
      const metaImages = doc.querySelector('meta[name="imageCount"]');
      const metaVideos = doc.querySelector('meta[name="videoCount"]');

      if (metaVersion) version = extractVersion(metaVersion.getAttribute("content"));
      if (metaFAQ) faq = metaFAQ.getAttribute("content") === "true";
      if (metaHowTo) howTo = extractVersion(metaHowTo.getAttribute("content"));

      // Get counts, fallback to 0
      links = metaLinks ? parseInt(metaLinks.getAttribute("content")) || 0 : 0;
      ads = metaAds ? parseInt(metaAds.getAttribute("content")) || 0 : 0;
      images = metaImages ? parseInt(metaImages.getAttribute("content")) || 0 : 0;
      videos = metaVideos ? parseInt(metaVideos.getAttribute("content")) || 0 : 0;
    }

    const result = { online: isOnline, version, faq, howTo, links, ads, images, videos };
    checkedDomains[url] = result;
    return result;
  } catch {
    const result = { online: false, version: null, faq: null, howTo: null, links: 0, ads: 0, images: 0, videos: 0 };
    checkedDomains[url] = result;
    return result;
  }
}

/* ---- new flow ---- */

// Step 1: Ping all pages first
async function fetchAllPages(pages) {

    //  console.log("pages:", pages);

  for (const p of pages) {
    const { online, version, faq, howTo, links, ads, images, videos } = await pingSite(p.slug);
    versions[p.siteId] = version;
    p.online = online;
    p.version = version;
    p.faq = faq;
    p.howTo = howTo;
    p.links = links ?? 0;
p.ads = ads ?? 0;
p.images = images ?? 0;
p.videos = videos ?? 0;

  }
}

// Step 2: Get the global latest version
function getLatestVersion() {
  const latestNum = getLatestVersionNumber(versions);
  return formatVersion(latestNum);
}

// Step 3: Update DOM for each page against the global latest
function renderPageStatus(p, latestVersion) {
  const statusEl  = document.getElementById(`status-${p.siteId}`);
  const versionEl = document.getElementById(`version-${p.siteId}`);
  const faqEl = document.getElementById(`faq-${p.siteId}`);
  const howToEl = document.getElementById(`howTo-${p.siteId}`);

  const linkCountEl = document.getElementById(`linkCount-${p.siteId}`);
  const adCountEl = document.getElementById(`adCount-${p.siteId}`);
  const imgCountEl = document.getElementById(`imgCount-${p.siteId}`);
  const videoCountEl = document.getElementById(`videoCount-${p.siteId}`);


  if (!statusEl) return;

if (faqEl) faqEl.textContent = p.faq ? "✅ FAQ Available" : "❌ No FAQ";
if (howToEl) howToEl.textContent = p.howTo ? "✅ HowTo Available" : "❌ No HowTo";

  if (linkCountEl) linkCountEl.textContent = p.links ?? 0;
  if (adCountEl) adCountEl.textContent = p.ads ?? 0;
  if (imgCountEl) imgCountEl.textContent = p.images ?? 0;
  if (videoCountEl) videoCountEl.textContent = p.videos ?? 0;


  if (!p.online) {
    statusEl.textContent = "❌ Offline";
    statusEl.className = "status-offline";
    if (versionEl) versionEl.textContent = "";
    return;
  } else {
    statusEl.textContent = "✅ Online";
    statusEl.className = "status-online";
  }

  if (!p.version) {
    versionEl.textContent = "⚠️ No version tag";
    versionEl.className = "status-warning";
  } else if (p.version === latestVersion) {
    versionEl.textContent = `✅ Latest (${p.version})`;
    versionEl.className = "status-latest";
  } else {
    versionEl.textContent = `⚠️ Outdated (${p.version})`;
    versionEl.className = "status-warning";
  }

  console.log("version:", p.version, "latestVersion:", latestVersion);
}

// Step 4: Orchestrate
async function updateAllPages(pages) {
  await fetchAllPages(pages);
  const latestVersion = getLatestVersion();
  console.log("🔥 Final latest version:", latestVersion);

  for (const p of pages) {
    renderPageStatus(p, latestVersion);
  }
}

let pageData = []; // global or module-level
let pageCache = {};
let sortState = { field: 'title', asc: true };

async function loadDashboard(autoPing = false) {
  console.log("autoPing  ", autoPing);
  console.log("loadDashboard Loading...  ");

  const dashboardContent = document.getElementById("dashboardContent");
  if (!dashboardContent) return;

  // Fetch all pages from Firestore
  const pagesCol = collection(db, "pages");
  const pagesSnap = await getDocs(pagesCol);
  pageData = pagesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

  if (!pageData.length) {
    dashboardContent.innerHTML = "<p>No pages yet.</p>";
    return;
  }

  // Cache pages
  pageCache = {};
  pageData.forEach(p => pageCache[p.id] = p);

  renderDashboard(pageData);

  // Sorting logic
  document.querySelectorAll(".sortable").forEach(th => {
    th.classList.remove("sorted-asc", "sorted-desc");
    if (sortState.field === th.dataset.field) {
      th.classList.add(sortState.asc ? "sorted-asc" : "sorted-desc");
    }

    th.onclick = () => {
      if (sortState.field === th.dataset.field) {
        sortState.asc = !sortState.asc;
      } else {
        sortState.field = th.dataset.field;
        sortState.asc = true;
      }

      const sorted = [...pageData].sort((a, b) => {
        const valA = a[sortState.field] ?? '';
        const valB = b[sortState.field] ?? '';
        if (valA < valB) return sortState.asc ? -1 : 1;
        if (valA > valB) return sortState.asc ? 1 : -1;
        return 0;
      });

      renderDashboard(sorted);
    };
  });

  // Auto-ping logic
  if (autoPing) {
    console.log("🚀 Auto-pinging all pages...");
    await updateAllPages(Object.values(pageCache));
  }
}
function filterPages(pages) {
  const searchVal = document.getElementById("searchInput").value.toLowerCase();
  const categoryVal = document.getElementById("searchCategory").value;

  const filterLinks = document.getElementById("filterLinks").checked;
  const filterAds = document.getElementById("filterAds").checked;
  const filterImages = document.getElementById("filterImages").checked;
  const filterNoImages = document.getElementById("filterNoImages").checked;
  const filterVideos = document.getElementById("filterVideos").checked;

  return pages.filter(p => {
    // 🔎 Search: check title, slug/url, keywords
    const matchesSearch =
      !searchVal ||
      (p.title && p.title.toLowerCase().includes(searchVal)) ||
      (p.slug && p.slug.toLowerCase().includes(searchVal)) ||
      (p.keywords && Array.isArray(p.keywords) && p.keywords.join(" ").toLowerCase().includes(searchVal));

    // 📂 Category filter
    const matchesCategory = !categoryVal || p.category === categoryVal;

    // 📊 Content count filters
    const matchesLinks   = !filterLinks   || (p.links   && p.links   > 0);
    const matchesAds     = !filterAds     || (p.ads     && p.ads     > 0);
    const matchesImages  = !filterImages  || (p.images  && p.images  > 0);
    const matchesVideos  = !filterVideos  || (p.videos  && p.videos  > 0);

    // 🖼️ No images filter (placeholder check or missing image)
    const matchesNoImages = !filterNoImages || (!p.image || p.image === "https://contenthub.guru/images/placeholder.png");

    // ✅ combine all
    return matchesSearch &&
           matchesCategory &&
           matchesLinks &&
           matchesAds &&
           matchesImages &&
           matchesVideos &&
           matchesNoImages;
  });
}


function refreshDashboard() {
  let filtered = filterPages(pageData);

  const sorted = [...filtered].sort((a, b) => {
    // 1. publishedCount (descending)
    const countA = a.publishedCount ?? 0;
    const countB = b.publishedCount ?? 0;
    if (countA !== countB) return countB - countA;

    // 2. category (alphabetical)
    const catA = a.category || "";
    const catB = b.category || "";
    if (catA !== catB) return catA.localeCompare(catB);

    // 3. updatedAt (newest first, Firestore timestamp safe)
    const updatedA = a.updatedAt?.toMillis?.() ?? 0;
    const updatedB = b.updatedAt?.toMillis?.() ?? 0;
    return updatedB - updatedA;
  });

  renderDashboard(sorted);
}


// Attach events
document.getElementById("searchInput").addEventListener("input", refreshDashboard);
document.getElementById("searchCategory").addEventListener("change", refreshDashboard);
document.getElementById("filterLinks").addEventListener("change", refreshDashboard);
document.getElementById("filterAds").addEventListener("change", refreshDashboard);
document.getElementById("filterImages").addEventListener("change", refreshDashboard);
document.getElementById("filterVideos").addEventListener("change", refreshDashboard);

// Separate function to render HTML table
function renderDashboard(pages) {
  const dashboardContent = document.getElementById("dashboardContent");
  let html = `<table>
    <thead>
      <tr>
        <th>Preview</th>
        <th class="sortable" data-field="title">Domain</th>
        <th class="sortable" data-field="category">Category</th>
        <th  class="sortable" data-field="status">Status</th>
        <th class="sortable" data-field="views">Views</th>
        <th  class="sortable" data-field="date">Actions</th>
      </tr>
    </thead>
    <tbody>`;

  for (const p of pages) {
    const pageUrl = `https://contenthub.guru/page/${p.slug}`;
    const shareText = encodeURIComponent(`Check out this page: ${p.title || ''}`);
    html += `<tr>
      <td><a href="${pageUrl}" target="_blank">
        <img class='siteImage' src="${p.image || 'https://contenthub.guru/images/placeholder.png'}" 
             alt="preview" width="300" height="200">
      </a></td>
      <td>${p.title || ''}</td>
      <td>
        <div id="category-${p.id}" class="category">${p.category || ''}</div>
        <div id="faq-${p.id}" class="faq_status">FAQ</div>
        <div id="howTo-${p.id}" class="howTo_status">howTo</div>


<!-- Live status counters -->
<div class="content-counts" aria-label="Content counts on this page">
  <div class="count-item">
    <span class="count-label">Links:</span>
    <span id="linkCount-${p.id}" class="count-value">${p.linkCount || 0}</span>
  </div>
  <div class="count-item">
    <span class="count-label">Ads:</span>
    <span id="adCount-${p.id}" class="count-value">${p.adCount || 0}</span>
  </div>
  <div class="count-item">
    <span class="count-label">Images:</span>
    <span id="imgCount-${p.id}" class="count-value">${p.imgCount || 0}</span>
  </div>
  <div class="count-item">
    <span class="count-label">Videos:</span>
    <span id="videoCount-${p.id}" class="count-value">${p.videoCount || 0}</span>
  </div>
</div>
      </td>
      <td><div id="status-${p.id}" class="status-offline">❌ Offline</div>
        <hr>
      <div id="version-${p.id}" class="version">version</div></td>
      <td><div class="sortable" data-field="views">${p.views || 0}</div></td>
      <td>
        <div class="sortable" data-field="date" class="action-buttons">
          <button class='updatePageBTN' onclick="updatePageBtn('${p.id}','${p.slug}', '${p.category}')">Update</button>
          <button onclick="window.open('https://contenthub.guru/admin/editor?id=${p.id}', '_blank')">Edit</button>
          <button class="remove-btn" onclick="removePage('${p.id}','${p.slug}')">Remove</button>
        </div>
   <div class="share-buttons" role="group" aria-label="Share this page">
  <button 
    onclick="shareOnTwitter('${pageUrl}', '${shareText}')" 
    aria-label="Share on Twitter" 
    data-platform="twitter">
    🐦
  </button>

  <button 
    onclick="shareOnLinkedIn('${pageUrl}', '${shareText}')" 
    aria-label="Share on LinkedIn" 
    data-platform="linkedin">
    💼
  </button>

  <button 
    onclick="shareOnFacebook('${pageUrl}')" 
    aria-label="Share on Facebook" 
    data-platform="facebook">
    📘
  </button>

  <button 
    onclick="shareOnAll('${pageUrl}', '${shareText}')" 
    aria-label="Share on multiple platforms" 
    data-platform="all">
    🌍
  </button>
</div>

      </td>
    </tr>`;
  }

  html += "</tbody></table>";
  dashboardContent.innerHTML = html;
  console.log("✅ Dashboard rendered with rows:", pages.length);

  
}


function shareOnAll(url, text) {


   shareNative(url, text);

   return;

  // Twitter
  const twitterUrl = `https://twitter.com/intent/tweet?text=${text}&url=${encodeURIComponent(url)}`;
  window.open(twitterUrl, '_blank', 'width=600,height=400');

  // LinkedIn
  const linkedinUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}&title=${text}`;
  window.open(linkedinUrl, '_blank', 'width=600,height=400');

  // Facebook
  const fbUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
  window.open(fbUrl, '_blank', 'width=600,height=400');
}

window.shareOnAll = shareOnAll;

function shareNative(url, text) {
  if (navigator.share) {
    navigator.share({
      title: text,
      text: text,
      url: url
    }).catch(err => console.error("Share failed:", err));
  } else {
    alert("Native share not supported in this browser.");
  }
}


function shareOnTwitter(url, text) {
  const twitterUrl = `https://twitter.com/intent/tweet?text=${text}&url=${encodeURIComponent(url)}`;
  window.open(twitterUrl, '_blank', 'width=600,height=400');
}

function shareOnLinkedIn(url, text) {
  const linkedinUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}&title=${text}`;
  window.open(linkedinUrl, '_blank', 'width=600,height=400');
}

function shareOnFacebook(url) {
  const fbUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
  window.open(fbUrl, '_blank', 'width=600,height=400');
}

window.shareOnTwitter = shareOnTwitter;
window.shareOnLinkedIn = shareOnLinkedIn;
window.shareOnFacebook = shareOnFacebook;







async function pingPages(){

  // Auto-ping logic
  if (autoPing) {
    console.log("🚀 Auto-pinging all pages...");
    await updateAllPages(Object.values(pageCache));
  }

}






async function updatePageBtn(siteId, slug, category) {
  try {

    
// Function to generate a random hex color
function getRandomColor() {
  const letters = "0123456789ABCDEF";
  let color = "#";
  for (let i = 0; i < 6; i++) {
    color += letters[Math.floor(Math.random() * 16)];
  }
  return color;
}

// Your base style keys
const baseStyle = {
  hrColor: null,
  headerBorder: null,
};

// ✅ Create just one random set
const styles = (() => {
  const randomColor = getRandomColor();
  return Object.fromEntries(
    Object.entries(baseStyle).map(([key]) => [key, randomColor])
  );
})();

//console.log("styles:", styles);


/*
    const response = await fetch("https://contenthub.guru/sitePages.json");

    if (!response.ok) {
      throw new Error(`Failed to fetch sitePages.json (${response.status})`);
    }

    const data = await response.json();

    if (!data || data.length === 0) {
      sitesList.innerHTML = "<p class='loading'>No websites yet. Create one after login.</p>";
      return;
    }


    */

    // 🔽 Get 4 lowest viewed pages (same category optional)
    let suggested = [];
    let sq;
    if (category) {
      sq = query(
        collection(db, "pages"),
        where("category", "==", category),
        orderBy("views", "asc"),
        limit(4)
      );
    } else {
      sq = query(
        collection(db, "pages"),
        orderBy("views", "asc"),
        limit(4)
      );
    }

const sSnap = await getDocs(sq);
sSnap.forEach((docSnap) => {
  const d = docSnap.data();
  suggested.push({
    id: docSnap.id,
    image: d.image || null,
    title: d.title || "",
    category: d.category || "",
    description: d.description || "",
    slug: d.slug || "",
    readTime: d.readTime || '',
    language: d.language || "en"
  });
});

const linkCountEl = document.getElementById(`linkCount-${siteId}`);
const adCountEl = document.getElementById(`adCount-${siteId}`);
const imgCountEl = document.getElementById(`imgCount-${siteId}`);
const videoCountEl = document.getElementById(`videoCount-${siteId}`);

// Extract values safely
const linkCount = linkCountEl ? parseInt(linkCountEl.textContent.trim(), 10) || 0 : 0;
const adCount = adCountEl ? parseInt(adCountEl.textContent.trim(), 10) || 0 : 0;
const imgCount = imgCountEl ? parseInt(imgCountEl.textContent.trim(), 10) || 0 : 0;
const videoCount = videoCountEl ? parseInt(videoCountEl.textContent.trim(), 10) || 0 : 0;

//const updateLanguage = document.getElementById(`updateLanguage`).value;

const updateData = {
  suggested,
  publishedCount: increment(1),
  status: "published",
  updatedAt: serverTimestamp(),
  styles: styles,

  // ✅ Add counts
  linkCount: linkCount,
  adCount: adCount,
  imgCount: imgCount,
  videoCount: videoCount,
  language: "en",
};


    // ✅ Update Firestore
    await setDoc(doc(db, "pages", siteId), updateData, { merge: true });

    // ✅ Fetch the updated page
    const docSnap = await getDoc(doc(db, "pages", siteId));
    if (!docSnap.exists()) {
      console.error("No page data found for:", siteId);
      return;
    }
    const articleData = docSnap.data();

    // ✅ Update UI row dynamically
      updatePage(articleData);

     // translateArticleData(articleData, targetLang = "en") 

    showToast("success", "Page updated!", 2500);

  } catch (err) {
    console.error("Error updating page:", err);
    console.warn("Failed to update page.");
  }
}

window.updatePageBtn = updatePageBtn;

// Remove page function
async function removePage(pageId, domain) {
  if (!confirm(`Are you sure you want to remove the page "${domain}"?`)) return;

  try {
    // 1️⃣ Remove page doc from "pages" collection
    await deleteDoc(doc(db, "pages", pageId));

    // 2️⃣ Remove page from user's createdPages array
    const userRef = doc(db, "users", currentUser.uid);
    const userSnap = await getDoc(userRef);
    if (userSnap.exists()) {
      const createdPages = userSnap.data().createdPages || [];
      const updatedPages = createdPages.filter(p => p.id !== pageId);
      await updateDoc(userRef, { createdPages: updatedPages });
    }


    // Randomized or complex approach
const parts = ['p', 'h', 'g'];
const randomizePart = (part) => {
    return part.split('').reverse().join('');
};

const part_1 = randomizePart(parts.join(''));
const part_2 = "_akXGrO51HwgEI";
const part_3 = "VWzDIghLbIE";
const part_4 = "G9MnTu0fIjKj";

const token = part_1 + part_2 + part_3 + part_4;

    // 3️⃣ Remove page from GitHub
    const owner = "RW-501", repo = "content-hub";
    const filePath = `page/${domain}.html`;
    const branch = "main";
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`;

    // Get file SHA first
    const fileResp = await fetch(url, { 
      method: "GET", 
      headers: { Authorization: `Bearer ${token}`, 'Accept':'application/vnd.github+json' } 
    });

    if (fileResp.ok) {
      const sha = (await fileResp.json()).sha;
      const deleteResp = await fetch(url, {
        method: "DELETE",
        headers: { Authorization: `Bearer ${token}`, 'Content-Type':'application/json', Accept:'application/vnd.github+json' },
        body: JSON.stringify({
          message: `Delete ${filePath}`,
          sha,
          branch
        })
      });
      if (!deleteResp.ok) throw new Error((await deleteResp.json()).message);
    }

    showToast("info", `Page "${domain}" removed successfully.`);
    await loadDashboard(true);

  } catch (err) {
    console.error(err);
    showToast("error", `Error removing page: ${err.message}`);
  }
}

window.removePage = removePage;



let stopUpdating = false;          // global flag
let updateDelay = 60000;            // default delay in ms

function createStatusPopup() {
  let popup = document.getElementById("update-status-popup");
  if (popup) return popup;

  popup = document.createElement("div");
  popup.id = "update-status-popup";
  popup.style.position = "fixed";
  popup.style.top = "0";
  popup.style.left = "0";
  popup.style.right = "0";
  popup.style.zIndex = "9999";
  popup.style.background = "#111";
  popup.style.color = "#fff";
  popup.style.fontFamily = "monospace";
  popup.style.fontSize = "13px";
  popup.style.padding = "10px";
  popup.style.height = "300px";
  popup.style.maxHeight = "100%";
  popup.style.overflowY = "auto";
  popup.style.boxShadow = "0 2px 8px rgba(0,0,0,0.5)";
  popup.style.borderBottom = "2px solid #444";
  popup.style.resize = "vertical";
  popup.innerHTML = `
    <div style="
    display: block;
    /* align-items: center; */
    font-weight: bold;
    margin-bottom: 5px;
    width: 100%;
">
        
      <div id="update-area1" style="
display: grid;
    width: 100%;
        ">
        <span>🔄 Page Update Status</span>
        <div id="update-area" style="
    display: flex;
    justify-content: space-evenly;

        ">
        <input id="update-speed" type="number" value="60000" style="width:60px; font-size:12px;">ms
        <button id="stop-popup-btn" style="
          background:#e74c3c; 
          color:#fff; 
          border:none; 
          border-radius:3px; 
          padding:2px 6px; 
          cursor:pointer;
          font-size:12px;
        ">⏹ Stop</button>
        <button id="close-popup-btn" style="
          background:#444; 
          color:#fff; 
          border:none; 
          border-radius:3px; 
          padding:2px 6px; 
          cursor:pointer;
          font-size:12px;
        ">❌</button>
        </div>
        </div>

    </div>
    <div id="status-progress">Progress: 0%</div>
    <div id="status-timer">⏰ Waiting...</div>
    <div id="status-summary">📊 Summary: 0 updated | 0 skipped | 0 errors</div>
    <hr style="border:0; border-top:1px solid #444; margin:5px 0;">
    <div id="status-log"></div>
  `;
  document.body.appendChild(popup);

  // Attach close button event
  document.getElementById("close-popup-btn").addEventListener("click", () => {
    popup.style.display = 'none';
  });

    // Attach close button event
  document.getElementById("logsBTN").addEventListener("click", () => {
    popup.style.display = 'block';
  });

  // Attach stop button
  document.getElementById("stop-popup-btn").addEventListener("click", () => {
    stopUpdating = true;
    logToPopup("⏹ Update stopped by user.", "red");
  });

  // Attach speed input
  const speedInput = document.getElementById("update-speed");
  speedInput.addEventListener("change", () => {
    const val = parseInt(speedInput.value);
    if (!isNaN(val) && val > 0) {
      updateDelay = val;
      logToPopup(`⚡ Update speed changed to ${updateDelay}ms`, "dodgerblue");
    }
  });

  return popup;
}


function updatePopupProgress(current, total, updated, skipped, errors, elapsed) {
  const percent = ((current / total) * 100).toFixed(0);

  // convert elapsed to minutes
  const elapsedMin = (elapsed / 60).toFixed(1);

  // estimate averages
  const avgPerItem = elapsed / current;
  const estTotal = avgPerItem * total;
  const estRemaining = estTotal - elapsed;

  const estTotalMin = (estTotal / 60).toFixed(1);
  const estRemainingMin = (estRemaining / 60).toFixed(1);

  // color logic for remaining time
  let timeColor;
  if (estRemaining <= 300) timeColor = "limegreen";   // < 5 min
  else if (estRemaining <= 900) timeColor = "orange"; // 5–15 min
  else timeColor = "red";                             // > 15 min

  // color logic for progress bar
  let barColor;
  if (percent < 40) barColor = "red";
  else if (percent < 80) barColor = "orange";
  else barColor = "limegreen";

  // add pulse animation at 100%
  const pulseStyle = percent == 100 
    ? "animation:pulse 1s infinite alternate;" 
    : "";

  document.getElementById("status-progress").innerHTML = `
    <div style="width:100%; background:#333; height:10px; border-radius:4px; overflow:hidden;">
      <div style="
        width:${percent}%; 
        height:100%; 
        background:${barColor}; 
        transition: width 0.5s ease;
        ${pulseStyle}
      "></div>
    </div>
    <div style="margin-top:4px;">
      Progress: ${percent}% (${current}/${total})
    </div>
  `;

  // inject color into "Left"
  document.getElementById("status-timer").innerHTML =
    `⏱ Elapsed: ${elapsedMin} min | ` +
    `<span style="color:${timeColor}">⏳ Left: ${estRemainingMin} min</span> | ` +
    `🕒 Total: ${estTotalMin} min`;

  document.getElementById("status-summary").textContent =
    `📊 Summary: ${updated} updated | ${skipped} skipped | ${errors} errors`;

  // inject keyframes once (if not already there)
  if (!document.getElementById("pulse-style")) {
    const style = document.createElement("style");
    style.id = "pulse-style";
    style.textContent = `
      @keyframes pulse {
        from { filter: brightness(1); }
        to { filter: brightness(1.6); }
      }
    `;
    document.head.appendChild(style);
  }
}



function logToPopup(message, color = "#ccc") {
  const logEl = document.getElementById("status-log");
  if (!logEl) return;
  const line = document.createElement("div");
  line.textContent = message;
  line.style.color = color;
  logEl.prepend(line); // newest on top
}

let oldPage = '';

async function updatePageStatus(page) {
  try {

    const { online, version, faq, howTo, links, ads, images, videos } = await pingSite(page.slug);

    // store version by siteId
    versions[page.siteId] = version;

    // update page object
    page.online  = online;
    page.version = version;
    page.faq     = faq;
    page.howTo   = howTo;
    page.links   = links  ?? 0;
    page.ads     = ads    ?? 0;
    page.images  = images ?? 0;
    page.videos  = videos ?? 0;

    // get latest version across all sites
    const latestVersion = getLatestVersion();

    logToPopup(`🔥 Pinged ${page.slug} updated V: ${version} `, "dodgerblue");
  console.log(`%c🔥 Pinged ${page.slug} updated V: ${version} `, "color: dodgerblue; font-weight: bold;");

      console.log("page:", page);

    // update UI
    renderPageStatus(page, latestVersion);
  } catch (err) {
    console.error("❌ Failed to update page status for", page.slug, err);
  }
}

  

async function scrollAndClick(page) {
  page.btn.scrollIntoView({ behavior: "smooth", block: "center" });
  const row = page.btn.closest("tr");
  row?.classList.add("highlight-row");

  if(oldPage){
  await updatePageStatus(oldPage);
  }
oldPage = page;

  await new Promise(r => setTimeout(r, 600));
  page.btn.click();
  setTimeout(() => row?.classList.remove("highlight-row"), 1500);
}

async function updateOutdatedPages() {
    stopUpdating = false; // reset
  const popup = createStatusPopup();

  const updateButtons = document.querySelectorAll(".updatePageBTN");
  const outdatedPages = Array.from(updateButtons)
    .map(btn => {
      const match = btn.getAttribute("onclick")?.match(/updatePageBtn\('([^']+)','([^']+)'/);
      if (!match) return null;

      const siteId = match[1];
      const slug = match[2];
      const versionEl = document.getElementById(`version-${siteId}`);
      const titleEl = btn.closest("tr")?.querySelector("td:nth-child(2)");

      return {
        siteId,
        slug,
        btn,
        versionEl,
        title: titleEl ? titleEl.textContent.trim() : "(No title found)",
        isOutdated: versionEl && versionEl.textContent.includes("Outdated")
      };
    })
    .filter(p => p !== null);

  if (outdatedPages.length === 0) {
    logToPopup("✅ No outdated pages found.", "limegreen");
    console.log("%c✅ No outdated pages found.", "color: limegreen; font-weight: bold;");
    return;
  }

  logToPopup(`🔍 Found ${outdatedPages.length} pages to check...`, "dodgerblue");
  console.log(`%c🔍 Found ${outdatedPages.length} pages to check...`, "color: dodgerblue; font-weight: bold;");

  let updatedCount = 0, skippedCount = 0, errorCount = 0;
  const startTime = Date.now();
  console.log(`%c⏰ Started at: ${new Date(startTime).toLocaleTimeString()}`, "color: gray;");

  for (let i = 0; i < outdatedPages.length; i++) {

    if(stopUpdating) return;

    const page = outdatedPages[i];
    const progressText = `(${i + 1}/${outdatedPages.length})`;
    const pageStart = Date.now();

    if (page.isOutdated) {
      try {
        await scrollAndClick(page);
        updatedCount++;
        const took = ((Date.now() - pageStart) / 1000).toFixed(1);
        logToPopup(`${progressText} 🔄 Updated: "${page.title}" (took ${took}s)`, "orange");
      } catch (err) {
        errorCount++;
        logToPopup(`${progressText} ❌ Error updating "${page.title}"`, "red");
      }
      await new Promise(r => setTimeout(r, updateDelay));
    } else {
      skippedCount++;
      logToPopup(`${progressText} ⏭️ Skipped (Up to date): "${page.title}"`, "gray");
    }

    const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
    updatePopupProgress(i + 1, outdatedPages.length, updatedCount, skippedCount, errorCount, elapsed);
  }

  const endTime = Date.now();
  const duration = ((endTime - startTime) / 1000).toFixed(1);
  logToPopup(`🎉 Finished all pages in ${duration}s`, "limegreen");

  console.log("%c🎉 Finished checking all pages.", "color: limegreen; font-weight: bold;");
  console.log(`%c⏰ Ended at: ${new Date(endTime).toLocaleTimeString()} (Duration: ${duration}s)`, "color: gray;");
  console.log(
    `%c📊 Summary: %c${updatedCount} updated %c| ${skippedCount} skipped %c| ${errorCount} errors`,
    "color: dodgerblue; font-weight: bold;",
    "color: orange; font-weight: bold;",
    "color: gray;",
    "color: red; font-weight: bold;"
  );
}

// Attach function to the button
document.getElementById("updateBTN").addEventListener("click", updateOutdatedPages);
document.getElementById("pingBTN").addEventListener("click", pingPages);


</script>
</body>
</html>
