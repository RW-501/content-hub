<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Translate Pages Dashboard</title>

<!-- Favicons -->
<link rel="apple-touch-icon" sizes="180x180" href="https://contenthub.guru/images/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://contenthub.guru/images/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://contenthub.guru/images/favicons/favicon-16x16.png">
<link rel="manifest" href="https://contenthub.guru/images/favicons/site.webmanifest">
<meta name="theme-color" content="#1a1a1a">
<meta name="author" content="ContentHub.guru">

<style>
  * { box-sizing: border-box; }
  :root { --card:#fff; --ink:#222; --muted:#666; --bg:#f7f7f9; --border:#e6e6ea; --accent:#4f46e5; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:var(--bg); color:var(--ink); }

  /* Container grid */
  #pages {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1.5rem;
    padding: 1.5rem;
  }

  /* Page card */
  .page-card {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 1rem 1.25rem;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .page-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 14px rgba(0,0,0,0.08);
  }
  .page-card h3 {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
  }
  .page-card p {
    font-size: 0.9rem;
    color: #6b7280;
    margin-bottom: 0.75rem;
  }

  /* Language buttons */
  .lang-btn {
    margin: 4px;
    padding: 6px 12px;
    border: none;
    font-size: 0.85rem;
    font-weight: 600;
    color: #fff;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s, transform 0.15s;
  }
  .lang-btn:hover {
    transform: scale(1.05);
  }
  .lang-btn.translated { background-color: #16a34a; }   /* green */
  .lang-btn.not-translated { background-color: #dc2626; } /* red */

  /* Reset button */
  .reset-btn {
    margin: 4px;
    padding: 6px 10px;
    font-size: 0.8rem;
    font-weight: 500;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    background: #f9fafb;
    color: #374151;
    cursor: pointer;
    transition: background 0.2s, transform 0.15s;
  }
  .reset-btn:hover {
    background: #f3f4f6;
    transform: scale(1.05);
  }

  /* Logs */
  #log,
  #status {
    margin: 1.5rem;
    padding: 1rem;
    background: #1f2937;
    color: #d1d5db;
    font-family: monospace;
    font-size: 0.85rem;
    border-radius: 8px;
    height: 150px;
    overflow-y: auto;
    white-space: pre-wrap;
    box-shadow: inset 0 0 6px rgba(0,0,0,0.4);
  }

  main { width: 95%; margin: 0 auto; }

  /* Base button */
  button {
    display: inline-block;
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
    font-weight: 600;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
  }

.lang-btn.live {
    color: white;
    border: solid blue;
}


</style>
</head>
<body>

<div id="admin-header"></div>
<script type="module">
  import { loadAdminHeader } from 'https://contenthub.guru/admin/exports/adminHeader.js';
  loadAdminHeader('admin-header');
</script>

<main>
  <h1>Translate Pages Dashboard</h1>

  


  <button id="translateWithDelayBtn">Translate & Update All Pages</button>

  <div class="container">
    <div id="select"></div>
    <h3 style="margin:1.5rem 0 0.5rem 1.5rem;">Logs</h3>
    <pre id="status"></pre>
    <pre id="log"></pre>
  </div>

  <div id="pages"></div>
</main>

<div id="admin-footer"></div>
<script type="module">
  import { loadFooter } from 'https://contenthub.guru/admin/exports/adminFooter.js';
  loadFooter();
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getFirestore, updateDoc, deleteField,  getDocs, query, collection, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

  import { translatePageLanguage, resetTranslation, removePage } from "https://contenthub.guru/admin/exports/updateArticle.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBXZcSYdspfi2jBipwUFeNmKZgU02ksg8c",
    authDomain: "contentmanagement-8af61.firebaseapp.com",
    projectId: "contentmanagement-8af61",
    storageBucket: "contentmanagement-8af61.firebasestorage.app",
    messagingSenderId: "579537581112",
    appId: "1:579537581112:web:736c7faafaf1391ce1e2cd",
    measurementId: "G-ZPWGF7YMPE"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);






/* ---------------- Config ---------------- */
const targetLangs = ["es", "fr", "de"];
//const targetLangs = ["es", "zh", "hi", "ar", "fr", "de"];

const pagesContainer = document.getElementById("pages");

// Unified log/status output
const logEl = document.getElementById("log");
const statusDiv = document.getElementById("status");

function writeLog(el, msg) {
  if (!el) return;
  el.textContent += msg + "\n";
  el.scrollTop = el.scrollHeight;
}

function log(msg) {
  writeLog(logEl, msg);
}

function status(msg) {
  writeLog(statusDiv, msg);
}

// Global lookup map (keeps references if needed)
const buttonIndex = {}; // { [pageId_lang]: HTMLElement }


async function ensureTranslationConsistency(pageId, lang, slug, btn) {
  const translatedUrl = `https://contenthub.guru/page/${lang}/${slug}.html`;

  try {
    const res = await fetch(translatedUrl, { method: "HEAD" });
    if (res.ok) {
      btn.classList.add("live");
      return true;
    } else {
      throw new Error(`Not found: ${res.status}`);
    }
  } catch (err) {
    log(`âš  ${lang.toUpperCase()} page missing. Cleaning DB...`);

    
    // ðŸ§¹ Clean up Firestore state
    await updateDoc(doc(db, "pages", pageId), {
      [`translatedLanguages.${lang}`]: deleteField(),
      [`translations.${lang}`]: deleteField()
    });

    btn.classList.remove("translated", "live");
    btn.classList.add("not-translated");

    return false;
  }
}

let  waitBool = true;

/* ---------------- Firestore -> Render ---------------- */
async function loadPages() {
  const q = query(collection(db, "pages"));
  const snap = await getDocs(q);
  pagesContainer.innerHTML = "";

  // Use for...of so we can await inside the loop
  for (const docSnap of snap.docs) {
    const data = docSnap.data();
    const pageId = docSnap.id;

    const div = document.createElement("div");
    div.className = "page-card";

    // Default URL (English)
    const defaultUrl = `https://contenthub.guru/page/${data.slug}.html`;

    // Title link
    const titleLink = document.createElement("a");
    titleLink.href = defaultUrl;
    titleLink.textContent = data.title;
    titleLink.target = "_blank";
    div.appendChild(titleLink);

    // Slug
    const slugP = document.createElement("p");
    slugP.textContent = `Slug: ${data.slug}`;
    div.appendChild(slugP);

    // Language buttons
    for (const lang of targetLangs) {
      const translated = data.translatedLanguages?.[lang] === true;

      const btn = document.createElement("button");
      btn.className = "lang-btn " + (translated ? "translated" : "not-translated");
      btn.textContent = lang.toUpperCase();

      // Save reference
      buttonIndex[`${pageId}_${lang}`] = btn;

      // Click handler for manual action
      btn.onclick = async () => {
        try {
          if (translated) {
            const confirmReset = confirm(
              `âš  ${data.slug} is already translated to ${lang.toUpperCase()}.\nDo you want to re-translate it?`
            );
            if (!confirmReset) {
              status(`â­ Skipped re-translation of ${data.slug} â†’ ${lang.toUpperCase()}`);
              return;
            }
          }

          status(`ðŸ”„ Translating ${data.slug} â†’ ${lang.toUpperCase()}`);
          const waitMs = await translatePageLanguage(pageId, data, lang);

          if (waitMs && waitMs > 0) {
                      waitBool = true;
            status(`âš  Quota hit. Pausing for ${formatTime(waitMs / 1000)}...`);
                   await waitForQuota(waitMs);
 
        state.waitEnd = Date.now() + waitMs;
        state.waitForIndex = state.index; // mark which index this wait corresponds to
        localStorage.setItem(AUTO_JOB_KEY, JSON.stringify(state));
  
          } else {
                      waitBool = false;
            status(`âœ… Done translating ${data.slug} â†’ ${lang.toUpperCase()}`);
          }
        } catch (err) {
          status(`âŒ Manual translation error: ${err.message}`);
        }
      };

      div.appendChild(btn);

      // If already translated, try to add link + live indicator
      if (translated && data.translations?.[lang]?.slug) {
  
      let updated =  await ensureTranslationConsistency(pageId, lang, data.translations[lang].slug, btn);
            
      if (!updated) {        
        status(`Updated DB`);
            }else{     
        //status(`No Update to DB`);
            }

  if (updated) {
    // Stop retrying this button â€” it's invalid now
    btn.classList.remove("translated", "live");
    btn.classList.add("not-translated");
  }

        const translatedUrl = `https://contenthub.guru/page/${lang}/${data.translations[lang].slug}.html`;

        const translatedLink = document.createElement("a");
        translatedLink.href = translatedUrl;
        translatedLink.textContent = `Go to ${lang.toUpperCase()} version`;
        translatedLink.target = "_blank";
        translatedLink.style.display = "block";
        translatedLink.style.marginTop = "4px";
        div.appendChild(translatedLink);

        // Reset button
        const resetBtn = document.createElement("button");
        resetBtn.className = "reset-btn";
        resetBtn.textContent = "Reset";

        resetBtn.onclick = async () => {
          try {
            const filePath = `page/${lang}/${data.slug}.html`;

            const confirmReset = confirm(
              `âš  ${data.slug} is already translated to ${lang.toUpperCase()}.\n\n` +
              `Do you want to RESET and re-translate?\n\nThis will delete:\n${filePath}`
            );

            if (!confirmReset) {
              log(`â­ Skipped reset for ${data.slug} (${lang.toUpperCase()})`);
              return;
            }

            log(`â™» Resetting ${filePath} (${lang})...`);
            await resetTranslation(pageId, lang);
            await removePage(pageId, filePath);
            await loadPages();
          } catch (err) {
            log(`âŒ Reset error: ${err.message}`);
          }
        };
        div.appendChild(resetBtn);
      }
    }

    pagesContainer.appendChild(div);
  }
}

/* ---------------- Auto Translate Job (with resume) ---------------- */
const AUTO_JOB_KEY = "autoTranslateJob";

function sleep(ms) {
  return new Promise(r => setTimeout(r, ms));
}

/**
 * HEAD-check a URL with retries (delay in ms).
 * returns true if any attempt succeeds.
 */
async function checkPageLive(url, retries = 4, delay = 10000) {
  for (let attempt = 1; attempt <= retries + 1; attempt++) {
    try {
      const res = await fetch(url, { method: "HEAD" });
      if (res.ok) return true;
    } catch (err) {
      log(`âŒ Error checking page: ${err.message}`);
    }

    if (attempt <= retries) {
      log(`ðŸ” Retry ${attempt}/${retries} in ${delay / 1000}s...`);
      await sleep(delay);
    }
  }
  return false;
}

/**
 * Auto-run that clicks each .lang-btn.not-translated in order.
 * It persists state to localStorage and resumes countdown if you reload.
 *
 * State shape saved to localStorage:
 * { index: number, waitEnd: msTimestamp | null }
 */
async function autoClickNotTranslated() {
  // always re-query buttons so DOM updates are respected
  const buttons = Array.from(document.querySelectorAll(".lang-btn.not-translated"));

  if (buttons.length === 0) {
    log("ðŸŽ‰ No untranslated buttons found. Job done!");
    localStorage.removeItem(AUTO_JOB_KEY);
    return;
  }

  // Load or create job state
  let state = JSON.parse(localStorage.getItem(AUTO_JOB_KEY)) || { index: 0, waitEnd: null };

  if (state.index >= buttons.length) {
    log("âœ… All buttons processed.");
    status("âœ… All buttons processed.");
    localStorage.removeItem(AUTO_JOB_KEY);
    return;
  }

  // main loop - do not use recursion to avoid stack growth
  while (state.index < buttons.length) {
    // Re-query the button in case DOM shifted; fallback to previous index if missing
    const btn = buttons[state.index] || document.querySelectorAll(".lang-btn.not-translated")[state.index];

    if (!btn) {
      log(`âš  Button at index ${state.index} disappeared; skipping.`);
      state.index++;
      state.waitEnd = null;
      localStorage.setItem(AUTO_JOB_KEY, JSON.stringify(state));
      continue;
    }

    const card = btn.closest(".page-card");
    const slugText = card?.querySelector("p")?.textContent || "Slug: unknown";
    const slug = slugText.replace("Slug: ", "").trim();
    const lang = btn.textContent.toLowerCase();
    const translatedUrl = `https://contenthub.guru/page/${lang}/${slug}.html`;

    try {
      // If we don't already have a waitEnd for this index, set it now
      if (!waitBool || !state.waitEnd || state.waitForIndex !== state.index) {
        // start a fresh 60s wait
        const waitMs = 60 * 1000;
        state.waitEnd = Date.now() + waitMs;
        state.waitForIndex = state.index; // mark which index this wait corresponds to
        localStorage.setItem(AUTO_JOB_KEY, JSON.stringify(state));
        log(`ðŸ‘‰ Clicking [${btn.textContent}] for ${slug}... (index ${state.index})`);
        btn.click();
      } else {
        // resuming existing wait
        log(`ðŸ” Resuming waiting for index ${state.index} (${slug})`);
      }

      // Wait loop - resume from remaining time instead of restarting
      while (true) {
        const now = Date.now();
        const remaining = Math.max(0, Math.ceil((state.waitEnd - now) / 1000)); // in seconds

        if (remaining <= 0) break;

        // Reduced spam: log every 10s and every second for last 5s
        if (remaining % 10 === 0 || remaining <= 5) {
          log(`â³ Waiting ${remaining}s before checking live page...`);
        }

        // Sleep 1s (or until waitEnd)
        await sleep(1000);

        // If user reloads, state is persisted, so loop will continue where it left off
      }

      // Wait finished (or already passed). Clear waitEnd before performing ping
      state.waitEnd = null;
      state.waitForIndex = null;
      localStorage.setItem(AUTO_JOB_KEY, JSON.stringify(state));


      // Ping with retries
      const isLive = await checkPageLive(translatedUrl, 2, 30000); // 2 retries, 30s apart

      if (isLive) {
        log(`ðŸŒ Live check passed: ${translatedUrl}`);
        btn.classList.remove("not-translated");
        btn.classList.add("translated", "live");

        // Add link if missing
        if (!card.querySelector(`a[href="${translatedUrl}"]`)) {
          const translatedLink = document.createElement("a");
          translatedLink.href = translatedUrl;
          translatedLink.textContent = `Go to ${lang.toUpperCase()} version`;
          translatedLink.target = "_blank";
          translatedLink.style.display = "block";
          translatedLink.style.marginTop = "4px";
          card.appendChild(translatedLink);
        }else{

        const translatedLink = document.createElement("a");
        translatedLink.href = translatedUrl;
        translatedLink.textContent = `Go to ${lang.toUpperCase()} version`;
        translatedLink.target = "_blank";
        translatedLink.style.display = "block";
        translatedLink.style.marginTop = "4px";
        div.appendChild(translatedLink);
        }
      } else {
        log(`âš  Still not live after retries: ${translatedUrl}`);
      }
    } catch (err) {
      log(`âŒ Error processing index ${state.index}: ${err.message}`);
      // don't get stuck â€” mark as attempted and continue
    }

    // advance to next and persist
    state.index++;
    state.waitEnd = null;
    state.waitForIndex = null;
    localStorage.setItem(AUTO_JOB_KEY, JSON.stringify(state));
  }

  // finished
  status("âœ… Finished all not-translated buttons.");
  localStorage.removeItem(AUTO_JOB_KEY);
}

/* ---------------- Start Button ---------------- */
// attach once (ensure element exists)
const startBtn = document.getElementById("translateWithDelayBtn");
if (startBtn) {
  startBtn.addEventListener("click", () => {
    // Prevent double-start in same session
    const currentJob = JSON.parse(localStorage.getItem(AUTO_JOB_KEY));
    if (currentJob && currentJob.index < document.querySelectorAll(".lang-btn.not-translated").length) {
      status("âš  Auto job already present in localStorage â€” resuming it instead of starting a new one.");
      autoClickNotTranslated();
    } else {
      autoClickNotTranslated();
    }
  });
}

/* ---------------- Helpers ---------------- */
function formatTime(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}m ${secs}s`;
}

/* ---------------- Initial load ---------------- */
loadPages();




const languagesSelect = ["es", "zh", "hi", "ar", "fr", "de"];

// Define labels + desired order (make sure these are real arrays!)
const langOptions = [
  { code: ["fr", "zh", "hi", "ar", "es", "de"], label: "French" },
  { code: ["de", "zh", "hi", "ar", "fr", "es"], label: "German" },
  { code: ["es", "zh", "hi", "ar", "fr", "de"], label: "Spanish" },
  { code: ["zh", "es", "hi", "ar", "fr", "de"], label: "Chinese" },
  { code: ["hi", "zh", "es", "ar", "fr", "de"], label: "Hindi" },
  { code: ["ar", "zh", "hi", "es", "fr", "de"], label: "Arabic" }
];

const selectDiv = document.getElementById("select");
const select = document.createElement("select");
select.id = 'selectLang';

langOptions.forEach(({ code, label }) => {
  // Ensure code is an array
  const mainCode = Array.isArray(code) ? code[0] : code;
  
  if (languagesSelect.includes(mainCode)) {
    const option = document.createElement("option");
    option.value = mainCode;
    option.textContent = label;
    select.appendChild(option);
  }
});

selectDiv.appendChild(select);


async function renameTranslationDocs() {
  const parentCollection = collection(db, "pages"); // <-- top-level collection
  const parentSnapshots = await getDocs(parentCollection);

  for (const parentDoc of parentSnapshots.docs) {
    console.log(`Checking article: ${parentDoc.id}`);

    // point to the "translations" subcollection
    const translationsCol = collection(db, "pages", parentDoc.id, "translations");
    const translationsSnap = await getDocs(translationsCol);

    for (const subDoc of translationsSnap.docs) {
      if (subDoc.id === "z") {
        const data = subDoc.data();

        // create new doc with "fr"
        const newDocRef = doc(db, "pages", parentDoc.id, "translations", "zh");
        await setDoc(newDocRef, data);

        // delete old doc
        await deleteDoc(subDoc.ref);

        console.log(`Renamed doc from f âž fr in ${parentDoc.id}/translations`);
      }
    }
  }

  console.log("All done âœ…");
}

// renameTranslationDocs().catch(console.error);

</script>
</body>
</html>
